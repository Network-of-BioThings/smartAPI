{% extends "main.html" %} {% include "smartapi-head.html" %} {% block content %}
{% include "header.html" %} {% raw %}
<style>
  .loadBlock {
    position: fixed;
    top: 0;
    width: 100%;
    padding: 20px;
    text-align: center;
    background: black;
    color: white;
    z-index: 1000;
  }
  .badgepill{
    border-radius: 5px;
    padding: 2px;
    color: white;
    display: inline;
  }
</style>
<main id="meta-app" class="white" style="width: 100%;" v-cloak>
  <div class="loadBlock row" v-if="loading && !apisProcessed">
    <div class="col s12 m2 center d-flex align-items-center">
      <i class="fa fa-cog fa-spin fa-fw fa-3x"></i>
    </div>
    <div class="col s12 m10 center">
      <h6 class="white-text">
        <template v-if="!apisLoaded">
          <i class="fa fa-cog fa-spin fa-fw"></i>
          Getting API metadata..
        </template>
        <template v-else>
          <i class="fa fa-check green-text" aria-hidden="true"></i>
          API metadata loaded
        </template>
      </h6>
      <ul>
        <li v-for="(p,i) in processes" :key="i">
          <i class="fa fa-check green-text" aria-hidden="true"></i>
          <small v-text="p"></small>
        </li>
      </ul>
      <h6 class="white-text">
        <template v-if="!apisProcessed">
          <i class="fa fa-cog fa-spin fa-fw"></i>
          Processing operations from metadata...
        </template>
        <template v-else>
          <i class="fa fa-check green-text" aria-hidden="true"></i>
          Processed <span v-text="operationsTotal"></span> operations
        </template>
      </h6>
    </div>
  </div>
  <div class="padding20 grey lighten-3">
    <div class="center">
      <h3>
        <img class="scale-in-center" src="/static/img/metakg-01.png" aria-label="NCATS" width="50px"
          style="max-width: 50px; max-height: 50px;" />
        Meta-KG
      </h3>
      <p>
        Search for API operations given a combination of input, output(s),
        and/or predicates.
      </p>
      <p>
        An <a href="#" @click.prevent="loadExample()">example</a> would be: all
        operations where the predicate is "treats" and its output is a
        "Disease".
      </p>
      <p style="text-align: right;">
        <a href="https://smart-api.info/api/metakg" target="_blank" rel="noreferrer"><small>Download
            Meta-KG dump</small></a>
      </p>
    </div>
    <hr />
    <!-- META KG SEARCH -->
    <div class="row">
      <div class="col s12">
        <form class="meta_kg_form">
          <div class="row">
            <div class="col s12 m4 input-field center">
              <h5 class="white-text">
                <i class="fa fa-sign-in black-text" aria-hidden="true"></i>
                INPUT TYPE
              </h5>
              <div class="center white-text">
                <small>(1 or Many)</small>
              </div>
              <pill-box type="input_type"></pill-box>
            </div>
            <div class="col s12 m4 input-field center">
              <h5 class="white-text">
                <i class="fa fa-connectdevelop purple-text" aria-hidden="true"></i>
                RELATIONSHIP
              </h5>
              <div class="center white-text">
                <small>(1 or Many)</small>
              </div>
              <pill-box type="predicate"></pill-box>
            </div>
            <div class="col s12 m4 input-field center">
              <h5 class="white-text">
                <i class="fa fa-circle orange-text" aria-hidden="true"></i>
                OUTPUT TYPE
              </h5>
              <div class="center white-text">
                <small>(1 or Many)</small>
              </div>
              <pill-box type="output_type"></pill-box>
            </div>
            <div class="col s12 center">
              <button v-if="!loading" class="btn red" type="button" @click.prevent="reset()">
                Clear
              </button>
            </div>
          </div>
        </form>
      </div>
      <div class="col s12 m4">
        <div v-show="results && results.length" class="collection-item red-text" style="padding: 1px;">
          <small v-text="results.length+' operations'"></small>
          <button :data-clipboard-text="window.location.href" @click="copy()" class="smallButton grey copyBtn"
            title="Copy to clipboard">
            <i class="fa fa-clipboard" aria-hidden="true"></i> Copy Search URL
          </button>
        </div>
        <div class="white padding20 resBox collection">
          <template v-show="results && results.length">
            <div class="collection-item row" style="padding: 2px;">
              <div class="col s3">
                <small>API</small>
              </div>
              <div class="col s9">
                <small>Relationship</small>
              </div>
            </div>
          </template>
          <template v-for="item in results">
            <div class="collection-item resultRow row" @mouseenter="highlightRow(item)"
              @mouseleave="unhighlightRow(item)" style="padding: 3px;">
              <div class="col s12 left">
                <small class="d-block">
                  <a target="_blank" rel="noreferrer" :href="'/registry?q='+item.association.smartapi.id">
                    <b v-text="item.association.api_name"></b>
                    <i @mouseenter="highlightRowAndZoom(item)" @mouseleave="recenterGraph()"
                      class="fa fa-search-plus pointer blue-grey-text" aria-hidden="true"></i>
                  </a>
                  <i class="fa fa-info-circle resultInfo pointer green-text" aria-hidden="true"
                    style="float: right;"></i>
                </small>
                <small class="s-badge lighten-4 grey-text" v-text="item.association.input_type"></small>
                <i class="fa fa-arrow-circle-right grey-text" aria-hidden="true"></i>
                <small class="s-badge lighten-5 purple-text" v-text="item.association.predicate"></small>
                <i class="fa fa-arrow-circle-right grey-text" aria-hidden="true"></i>
                <small class="s-badge lighten-5 orange-text" v-text="item.association.output_type"></small>
              </div>
            </div>
          </template>
          <template v-if="results.length == 0 && !loading">
            <small class="grey-text">No Results</small>
          </template>
        </div>
      </div>
      <div class="col s12 m8" style="
          overflow: hidden;
          border: white solid 2px;
          margin: auto;
          background: #f2f2f2;
          margin-top: 10px;
        ">
        <div v-if="loading" class="purple-text padding20 center">
          <h4>Loading...</h4>
        </div>
        <div v-show="!loading" class="d-flex justify-content-around">
          <small class="pointer grey-text" @click="recenterGraph()"><i class="fa fa-dot-circle-o"
              aria-hidden="true"></i> Reset
            Zoom</small>
        </div>
        <div v-if="!loading && results.length == 0" class="deep-orange-text padding20 center">
          <img src="/static/img/api-error.svg" width="150px" alt="oh no.." />
          <h4>No Results, Please Refine Your Query</h4>
        </div>
        <div id="cy"></div>
        <div v-show="showTags" id="tags" class="padding20 d-flex flex-wrap">
          <template v-for="tag in tagList" :key="tag">
            <small style="margin: 1px;" class="pointer s-badge grey-text" @mouseenter="allWithTag(tag)"
              @mouseleave="allWithTagUndo(tag)">
              <i class="fa fa-tag" aria-hidden="true"></i>
              <span v-text="tag"></span>
            </small>
          </template>
        </div>
        <div v-show="!loading" class="text-right container d-flex justify-content-around">
          <small class="pointer grey-text" @click="download">
            <i class="fa fa-download" aria-hidden="true"></i> Download Image
          </small>
        </div>
      </div>
    </div>
  </div>
</main>

{% endraw %} {% include "footer.html" %} {% endblock %} {% block extra_scripts
%}
<script src="https://unpkg.com/vuex"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.min.js"></script>
<script src="/static/js/clipboard.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@biothings-explorer/smartapi-kg@1.5.1/bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.15.1/cytoscape.min.js"
  integrity="sha256-oYPiLQ2sL4jlYuCJE3rDZFD0OUy8t1fL6U0wIWyqUf8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.6/marked.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/remarkable/1.7.1/remarkable.js"></script>
<script src="https://unpkg.com/popper.js@1.14.7/dist/umd/popper.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-popper@1.0.5/cytoscape-popper.min.js"></script>
<script src="https://unpkg.com/tippy.js@5/dist/tippy-bundle.iife.js"></script>
<link rel="stylesheet" href="https://unpkg.com/tippy.js@5/dist/backdrop.css" />
<link rel="stylesheet" href="https://unpkg.com/tippy.js@5/themes/light.css" />

<script>
  // vue dev tools on inspector
  // Vue.config.devtools = true

  const store = new Vuex.Store({
    state: {
      'name': Object,
      "meta_kg": null,
      "results": [],
      "output_autocomplete": [],
      "input_autocomplete": [],
      "predicate_autocomplete": [],
      "cyto_data": [],
      "output_type": [],
      "input_type": [],
      "predicate": [],
      "apis": {},
      'cy': null,
      "predicate_selected": [],
      "input_selected": [],
      "output_selected": [],
      "spread": false,
      "tagList": [],
      "operationsTotal": 0,
      "loading": false,
      "predicate_autocomplete_all": [],
      "processes": []
    },
    strict: true,
    mutations: {
      toggleLoading(state, payload) {
        state.loading = payload['loading'];
      },
      addProcess(state, payload) {
        let process = payload['p'];
        state.processes.push(process)
      },
      reset(state) {
        let changes = false
        // only clear if it has something or it will trigger a search unnecessailty on other components
        if (state.predicate_selected.length) {
          state.predicate_selected = [];
          changes = true
        }
        if (state.input_selected.length) {
          state.input_selected = [];
          changes = true
        }
        if (state.output_selected.length) {
          state.output_selected = [];
          changes = true
        }
        // if (!changes) {
        //   Swal.fire({
        //     type: 'warning',
        //     toast: true,
        //     title: 'Nothing to clear',
        //     showConfirmButton: false,
        //     timer: 2000
        //   });
        // }
        changes = false

        state.predicate = [];
        state.input_type = [];
        state.output_type = [];
      },
      saveInput(state, payload) {

        let name = payload['name'];

        switch (name) {
          case 'output_type':
            state.output_type = payload["q"]
            break;
          case 'input_type':
            state.input_type = payload["q"]
            break;
          case 'predicate':
            state.predicate = payload["q"]
            break;
          default:
            console.log('no match')
        }
      },
      drawGraph(state, payload) {
        const t0 = performance.now();
        var self = this;

        this.cy = cytoscape({
          container: document.getElementById('cy'),
          elements: state.cyto_data,
          hideEdgesOnViewport: true,
          layout: {
            name: "concentric",
            avoidOverlap: true,
            avoidOverlapPadding: 200,
            minNodeSpacing: 10,
            minNodeSpacing: 200,
          },
          style: [
            {
              selector: 'node',
              style: {
                'content': 'data(name)',
                'min-zoomed-font-size': '2em',
                "text-valign": "bottom",
                "text-halign": "center",
                'color': '#3c5f99',
                'font-size': '3em',
                'text-outline-width': 4,
                'text-outline-color': 'white',
                'background-color': '#9c27b0',
                'z-index': 1000
              }
            },
            {
              selector: 'node:selected',
              style:{
                'background-color': 'red',
              }
            },
            {
              selector: 'edge',
              style:{
                'curve-style': 'bezier',
                'line-color': 'lightblue',
                'target-arrow-shape': 'triangle',
                'target-arrow-color': '#257FC5',
                'width': 2,
                'z-index': 1,
              }
            },
            {
              selector: 'edge:selected',
              style:{
                'z-index': 1000,
                'color': '#9c27b0',
                'font-size': '2.5em',
                'width': 4,
                'line-color': '#f24141',
                'target-arrow-color': '#f24141',
                'arrow-scale': 2
              }
            },
            {
              selector: '.highlightedTag',
              style:{
                'line-color': '#673782',
                'target-arrow-color': '#f24141',
                'width': 4,
              }
            },
            {
              selector: '.highlightedAPI',
              style:{
                'line-color': 'red',
                'target-arrow-color': '#f24141',
                'width': 4,
                }
            },
          ]
        });

        this.cy.$('node').on('grab', function (e) {
          var ele = e.target;
          ele.connectedEdges().select()
        });

        this.cy.on('mouseover', 'edge', function(evt){
          var edge = evt.target;
          edge.select()
        });

        this.cy.on('mouseout', 'edge', function(evt){
          var edge = evt.target;
          edge.deselect()
        });

        this.cy.$('node').on('free', function (e) {
          var ele = e.target;
          ele.connectedEdges().unselect()
        });

        function makePopper(ele) {
          let ref = ele.popperRef();
          ele.tippy = tippy(document.createElement('div'), {
            content: ele.id(),
            hideOnClick: false,
            flipOnUpdate: true,
            placement:'top-start',
            sticky: true,
            theme:'light',
            onShow(instance) {
              instance.popperInstance.reference = ref;
            },
          });
        }

        function makePopperEdge(ele) {
          let ref = ele.popperRef();
          ele.tippy = tippy(document.createElement('div'), {
            content:`<div><h6 class="center">`+ele.data('api_name')+`</h6><b class="grey darken-2 badgepill">`+ele.data('source')+
              `</b> <b class="purple-text">`+ele.data('predicate')+
              `</b> <b class="orange darken-2 badgepill">`+ele.data('target')+
              `</b></div>`,
            hideOnClick: false,
            flipOnUpdate: true,
            placement:'top-start',
            sticky: true,
            theme:'light',
            onShow(instance) {
              instance.popperInstance.reference = ref;
            },
          });
        }

        
        this.cy.ready(function () {
          self.cy.elements().forEach(function (ele) {           
            if(!ele.isNode()){
              makePopperEdge(ele);
            }else{
              makePopper(ele);
            }
          });
        });

        this.cy.elements().unbind('mouseover');
        this.cy.elements().bind('mouseover', (event) => event.target.tippy.show());

        this.cy.elements().unbind('mouseout');
        this.cy.elements().bind('mouseout', (event) => event.target.tippy.hide());

        this.cy.elements().unbind('drag');
        this.cy.elements().bind('drag', (event) => event.target.tippy.popperInstance.update());

        this.cy.maxZoom(2)

        const t1 = performance.now();
        var seconds = (((t1 - t0) % 60000) / 1000).toFixed(0);
        console.log(`%c Rendering graph took ${seconds} seconds.`, 'color:yellow');

        state.processes.push(`Rendered graph in ${seconds} seconds.`)
      },
      saveContext(state, payload) {
        state.name = payload['context']['portal'];
      },
      saveCytoData(state, payload) {
        state.cyto_data = payload['data'];
      },
      saveOperations(state, payload) {
        state.operations = payload['ops'];
      },
      getNewOptions(state, payload) {
        let filteredOptions = payload['res'];
        const t0 = performance.now();

        // PREDICATES
        if (!state.output_selected.length && !state.input_selected.length) {
          // restore all options from backup
          state.predicate_autocomplete = state.predicate_autocomplete_all
        } else {
          state.predicate_autocomplete = []
          for (var i = 0; i < filteredOptions.length; i++) {
            // if IO only show what's available
            if (!state.predicate_autocomplete.includes(filteredOptions[i]['association']['predicate'])) {
              state.predicate_autocomplete.push(filteredOptions[i]['association']['predicate'])
            }
          }
        }

        // INPUT
        if (state.output_selected.length && !state.input_selected.length) {
          // console.log('only output')
          state.input_autocomplete = []
          for (var i = 0; i < filteredOptions.length; i++) {
            if (!state.input_autocomplete.includes(filteredOptions[i]['association']['input_type'])) {
              state.input_autocomplete.push(filteredOptions[i]['association']['input_type'])
            }
          }
        } else if (state.input_selected.length && !state.output_selected.length) {
          //OUTPUT
          // console.log('only input')
          state.output_autocomplete = []
          for (var i = 0; i < filteredOptions.length; i++) {
            if (!state.output_autocomplete.includes(filteredOptions[i]['association']['output_type'])) {
              state.output_autocomplete.push(filteredOptions[i]['association']['output_type'])
            }
          }
        } else {
          // console.log('both')
          state.output_autocomplete = []
          state.input_autocomplete = []
          for (var i = 0; i < filteredOptions.length; i++) {
            if (!state.output_autocomplete.includes(filteredOptions[i]['association']['output_type'])) {
              state.output_autocomplete.push(filteredOptions[i]['association']['output_type'])
            }
            if (!state.input_autocomplete.includes(filteredOptions[i]['association']['input_type'])) {
              state.input_autocomplete.push(filteredOptions[i]['association']['input_type'])
            }
          }
        }

        const t1 = performance.now();
        var seconds = (((t1 - t0) % 60000) / 1000).toFixed(0);
        console.log(`%c (getNewOptions) Calculating input options took ${seconds} seconds.`, 'color:cyan');

        state.processes.push(`Calculated input options in ${seconds} seconds.`)

      },
      loadMetaKG(state, payload) {
        state.meta_kg = payload['graph']
        //Initial data Processing
        const t0 = performance.now();
        //all nodes and edges
        let data = []
        let nodes = new Set()
        state.operationsTotal = state.meta_kg.ops.length

        console.log(state.meta_kg.ops)

        state.meta_kg.ops.forEach((op, i) => {
          
          nodes.add(op['association']['input_type']);
          nodes.add(op['association']['output_type']);

          let edgeName = op['association']['api_name'] + ' : ' + op['association']['predicate'];

          let edge = {
            group: 'edges',
            data: {
              id: edgeName + i,
              name: edgeName,
              predicate: op['association']['predicate'],
              output_id: op['association']['output_id'],
              api_name: op['association']['api_name'],
              type: op['association']['api_name'],
              source: op['association']['input_type'],
              target: op['association']['output_type'],
            }
          };

          data.push(edge);

          // Autocomplete
          if (!state.output_autocomplete.includes(op['association']['output_type'])) {
            state.output_autocomplete.push(op['association']['output_type']);
          }
          if (!state.input_autocomplete.includes(op['association']['input_type'])) {
            state.input_autocomplete.push(op['association']['input_type']);
          }
          if (!state.predicate_autocomplete.includes(op['association']['predicate'])) {
            state.predicate_autocomplete.push(op['association']['predicate']);
          }

          // APIs
          if (op['association']['api_name'] in state.apis) {
            state.apis[op['association']['api_name']]++
          } else {
            state.apis[op['association']['api_name']] = 1
          }

        });


        [...nodes].forEach(node => {
          data.push({ 
            group: 'nodes',          
            data: {
              name: node,
              id: node
            }
          });
        });

        state.cyto_data = data;

        //save backup of all options for getNewOptions
        state.predicate_autocomplete_all = state.predicate_autocomplete;

        let p = {}
        p['loading'] = false;
        store.commit('toggleLoading', p);

        // starting results on left panel
        state.results = state.meta_kg.ops;

        const t1 = performance.now();
        var seconds = (((t1 - t0) % 60000) / 1000).toFixed(0);
        console.log(`%c Parsing initial data took ${seconds} seconds.`, 'color:pink');

        state.processes.push(`Processed initial data in ${seconds} seconds.`)
      },
      saveResults(state, payload) {
        state.results = payload['res']
        const t0 = performance.now();

        let data = []
        let nodes = new Set()

        state.results.forEach((result, i) => {
          nodes.add(result['association']['input_type'])
          nodes.add(result['association']['output_type'])

          let edgeName = result['association']['api_name'] + ' : ' + result['association'][
            'predicate'
          ]

          let edge = {
            group: 'edges',
            data: {
              id: edgeName + i,
              name: edgeName,
              predicate: result['association']['predicate'],
              output_id: result['association']['output_id'],
              api_name: result['association']['api_name'],
              source: result['association']['input_type'],
              target: result['association']['output_type'],
            }
          };

          data.push(edge)
        });
        
        [...nodes].forEach(node => {
          data.push({ 
            group: 'nodes',          
            data: {
              name: node,
              id: node
            }
          });
        });

        state.cyto_data = data

        const t1 = performance.now();
        var seconds = (((t1 - t0) % 60000) / 1000).toFixed(0);
        console.log(`(saveResults) Creating new nodes from search took ${seconds} seconds.`);

      },
      pushPill(state, payload) {
        let type = payload["type"]
        let q = payload["q"]

        switch (type) {
          case 'predicate':
            if (!state.predicate_selected.includes(q)) {
              state.predicate_selected.push(q)
            } else {
              Swal.fire({
                type: 'error',
                toast: true,
                title: 'Already Selected',
                showConfirmButton: false,
                timer: 1000
              });
            }

            break;
          case 'input_type':
            if (!state.input_selected.includes(q)) {
              state.input_selected.push(q)
            } else {
              Swal.fire({
                type: 'error',
                toast: true,
                title: 'Already Selected',
                showConfirmButton: false,
                timer: 1000
              });
            }

            break;
          case 'output_type':
            if (!state.output_selected.includes(q)) {
              state.output_selected.push(q)
            } else {
              Swal.fire({
                type: 'error',
                toast: true,
                title: 'Already Selected',
                showConfirmButton: false,
                timer: 1000
              });
            }

            break;
          default:
            console.log('NO option pushPill')
        }
      },
      removePill(state, payload) {
        let type = payload["type"]
        let q = payload["q"]
        let i = ''

        switch (type) {
          case 'predicate':
            i = state.predicate_selected.indexOf(q);
            state.predicate_selected.splice(i, 1);
            break;
          case 'input_type':
            i = state.input_selected.indexOf(q);
            state.input_selected.splice(i, 1);
            break;
          case 'output_type':
            i = state.output_selected.indexOf(q);
            state.output_selected.splice(i, 1);
            break;
          default:
            console.log('NO option removePill')
        }
      },
      handleParams(state, payload) {
        let params = payload['params']

        params = new URLSearchParams(params);

        let array = ['input_type', 'predicate', 'output_type']

        for (var x = 0; x < array.length; x++) {
          let current_inputtype = array[x]

          let type = params.get(current_inputtype);
          if (type) {
            let selections = type.split(',');

            for (var i = 0; i < selections.length; i++) {
              var payload = {};
              payload["type"] = current_inputtype;
              payload["q"] = selections[i];
              store.commit('pushPill', payload);

              var payload2 = {};
              payload2["name"] = current_inputtype;
              payload2["q"] = self.selected;
              store.commit('saveInput', payload2);
            }
          }
        }


      }
    },
    getters: {
      getAPIS: (state) => {
        return state.apis
      },
      getName: (state) => {
        return state.name
      },
      getI_AC: (state) => {
        return state.input_autocomplete
      },
      getP_AC: (state) => {
        return state.predicate_autocomplete
      },
      getO_AC: (state) => {
        return state.output_autocomplete
      },
      getI_Selected: (state) => {
        return state.input_selected
      },
      getP_Selected: (state) => {
        return state.predicate_selected
      },
      getO_Selected: (state) => {
        return state.output_selected
      },
      getHtml: (state) => {
        for (var name in state.portals) {
          if (name == state.name) {
            return state.portals[name]
          }
        }
      },
      getResults: (state) => {
        return state.results
      },
      getCytoData: (state) => {
        return state.cyto_data
      },
      getSpread: (state) => {
        return state.spread
      },
      getTagList: (state) => {
        return state.tagList
      },
      getAPITotal: (state) => {
        return state.operationsTotal
      },
      getLoading: (state) => {
        return state.loading
      },
      getProcesses: (state) => {
        return state.processes
      },
    },
    actions: {
      recenterGraph({
        commit,
        state
      }) {
        this.cy.fit();
      },
      highlightThis({
        commit,
        state
      }, payload) {
        let name = payload['highlight']
        let self = this;
        let found = this.cy.filter(function (element, i) {
          if (element.isEdge() && element.data('name').includes(name)) {
            return element;
          }
        });
        found.addClass('highlightedAPI');
      },
      unhighlightThis({
        commit,
        state
      }, payload) {
        let name = payload['unhighlight']
        this.cy.elements().removeClass('highlightedAPI')
        // this.cy.$('edge[type="'+name+'"]').style({ 'line-color': 'lightblue','width': 2 });
      },
      allWithTag({
        commit,
        state
      }, payload) {
        let name = payload['highlight']
        let self = this;

        let found = this.cy.filter(function (element, i) {
          if (element.isEdge() && element.data('tags').includes(name)) {
            return element;
          }
        });
        found.addClass('highlightedTag')

      },
      allWithTagUndo({
        commit,
        state
      }, payload) {
        this.cy.elements().removeClass('highlightedTag')
      },
      highlightRowAndZoom({
        commit,
        state
      }, payload) {

        let item = payload['item']
        let p = item['association']['predicate']
        let s = item['association']["input_type"]
        let t = item['association']["output_type"]
        let o = item['association']["output_id"]
        let a = item['association']["api_name"]



        let found = this.cy.filter(function (element, i) {
          if (element.isEdge() && element.data('predicate') == p) {
            if (element.source().data('name') == s && element.target().data('name') == t) {
              if (element.data('output_id') == o && element.data('api_name') == a) {
                return element;
              }
            }
          }
        });
        // let found2 = this.cy.filter('node').style({
        //   'opacity': .3
        // })
        found.select()
        found.connectedNodes().style({
          'opacity': 1
        })

        this.cy.fit(found, 75)
      },
      highlightRow({
        commit,
        state
      }, payload) {

        let item = payload['item']
        let p = item['association']['predicate']
        let s = item['association']["input_type"]
        let t = item['association']["output_type"]
        let o = item['association']["output_id"]
        let a = item['association']["api_name"]



        let found = this.cy.filter(function (element, i) {
          if (element.isEdge() && element.data('predicate') == p) {
            if (element.source().data('name') == s && element.target().data('name') == t) {
              if (element.data('output_id') == o && element.data('api_name') == a) {
                return element;
              }
            }
          }
        });
        // let found2 = this.cy.filter('node').style({
        //   'opacity': .3
        // })
        found.select()
        found[0].tippy.show()
        found.connectedNodes().style({
          'opacity': 1
        })
      },
      unhighlightRow({
        commit,
        state
      }, payload) {
        // let name = payload['unhighlight']
        // this.cy.elements().unselect()
        let item = payload['item']
        let p = item['association']['predicate']
        let s = item['association']["input_type"]
        let t = item['association']["output_type"]
        let o = item['association']["output_id"]
        let a = item['association']["api_name"]



        let found = this.cy.filter(function (element, i) {
          if (element.isEdge() && element.data('predicate') == p) {
            if (element.source().data('name') == s && element.target().data('name') == t) {
              if (element.data('output_id') == o && element.data('api_name') == a) {
                return element;
              }
            }
          }
        });
        let found2 = this.cy.filter('node').style({
          'opacity': 1
        })
        found.unselect()
        found[0].tippy.hide()
        this.cy.filter('node').style({
          'opacity': 1
        })
      },
      handle_metaKG_Query_New({
        commit,
        state
      }) {
        // console.log(state)
        let q = {}
        if (state.output_type && state.output_type.length) {
          q['output_type'] = state.output_type
        }
        if (state.predicate && state.predicate.length) {
          q['predicate'] = state.predicate
        }
        if (state.input_type && state.input_type.length) {
          q['input_type'] = state.input_type
        }

        console.log("%c Executing new query...", "color:lightblue")
        console.log(JSON.stringify(q, null, 2))

        let g = state.meta_kg.filter(q);

        if (g) {
          var payload = {};
          payload["res"] = g;
          commit('saveResults', payload);

          var pay = {};
          pay["res"] = g;
          commit('getNewOptions', pay);

          commit('drawGraph');
        }
      },
      download({
        commit,
        state
      }) {

        let options = {
          "bg": "white",
          "full": true,
          "quality": 1,
          "output": 'blob'
        }

        let pic = this.cy.png(options)

        var a = document.createElement("a");
        var file = new Blob([pic], {
          type: 'image/png'
        });
        a.href = URL.createObjectURL(file);
        a.download = 'meta-kg-graph';
        a.click();

        Swal.fire({
          type: 'success',
          toast: true,
          title: 'Success',
          showConfirmButton: false,
          timer: 2000
        });

      },
      buildURL({
        commit,
        state
      }) {

        let base = window.location.origin + window.location.pathname
        let finalURL = window.location.href
        // console.log('finalURL START',finalURL)
        let url = new URL(finalURL);

        let params = new URLSearchParams(url.search.slice(1));

        if (state.predicate_selected.length) {
          //something is selected
          params.set('predicate', state.predicate_selected.toString());
        } else {
          //nothing selected
          if (params.get('predicate')) {
            params.delete('predicate');
          }
        }

        if (state.input_selected.length) {
          //something is selected
          params.set('input_type', state.input_selected.toString());
        } else {
          //nothing selected
          if (params.get('input_type')) {
            params.delete('input_type');
          }
        }

        if (state.output_selected.length) {
          //something is selected
          params.set('output_type', state.output_selected.toString());
        } else {
          //nothing selected
          if (params.get('output_type')) {
            params.delete('output_type');
          }
        }

        finalURL = base + "?" + params

        //HTML5 change url history
        window.history.pushState({
          "html": 'content',
          "pageTitle": 'SmartAPI'
        }, "MetaKG", finalURL);
      },
    }
  });

  Vue.component('pill-box', {
    data: function () {
      return {
        'q': '',
        'lookupResults': [],
      }
    },
    props: ['type'],
    methods: {
      handlePillSubmit() {
        var self = this;

        if (self.options.includes(self.q)) {
          var payload = {};
          payload["type"] = self.type;
          payload["q"] = self.q;

          store.commit('pushPill', payload);
        } else {
          Swal.fire({
            type: 'error',
            toast: true,
            title: 'Not an option',
            showConfirmButton: false,
            timer: 1000
          });
        }

        var payload = {};
        payload["name"] = self.type;
        payload["q"] = self.selected;

        store.commit('saveInput', payload);
        self.q = ''
        // store.dispatch('handle_metaKG_Query_New')
      },
      remove(item) {
        var self = this;

        var payload = {};
        payload["type"] = self.type;
        payload["q"] = item;

        store.commit('removePill', payload);
        // store.dispatch('handle_metaKG_Query_New')
      },
      getBackClass() {
        var self = this;

        switch (self.type) {
          case 'predicate':
            return "purple";
            break;
          case 'input_type':
            return "grey";
            break;
          case 'output_type':
            return "orange";
            break;
          default:
            return 'white'
        }
      }
    },
    watch: {
      q: function (q) {
        //after selecting from datalist automatically send selection
        //if selection exists
        var self = this;
        if (q && self.options.includes(q)) {
          self.handlePillSubmit();
        }
      },
      options: function (o) {
        var self = this;
        let html = '';
        if (o.length) {
          var dataList = $("#" + self.type + 'list');
          dataList.empty();
          for (var i = 0, len = o.length; i < len; i++) {
            let item = o[i]
            html += `<option value="` + item + `">`;
          }
          $("#" + self.type + 'list').append(html);
        }
      },
      selected: function (s) {
        var self = this;
        // load example by watching selected
        var payload = {};
        payload["name"] = self.type;
        payload["q"] = s;

        store.commit('saveInput', payload);

        store.dispatch('handle_metaKG_Query_New')
        store.dispatch('buildURL');

      },
    },
    mounted: function () {
      var self = this;

    },
    computed: {
      options: function () {
        var self = this;
        switch (self.type) {
          case 'predicate':
            return store.getters.getP_AC
            break;
          case 'input_type':
            return store.getters.getI_AC
            break;
          case 'output_type':
            return store.getters.getO_AC
            break;
          default:
            console.log('NO AUTOCOMPLETE')
        }

      },
      selected: function () {
        var self = this;
        switch (self.type) {
          case 'predicate':
            return store.getters.getP_Selected
            break;
          case 'input_type':
            return store.getters.getI_Selected
            break;
          case 'output_type':
            return store.getters.getO_Selected
            break;
          default:
            console.log('NO SELECTED OPTIONS')
        }

      },
      loading: function () {
        return store.getters.getLoading
      },
    },
    template: `<div>
        <div class="pillBox lighten-4" :class="getBackClass()">
          <form @submit.prevent="handlePillSubmit" style="display:inline;">
            <input style="width: 100%;" :disabled="loading" v-model='q' :class="getBackClass()" class="browser-default pill-input lighten-4" type="text" name="search" :id="type" :placeholder="loading?'Please wait':'Search'" :list="type+'list'" autocomplete="off">
            <datalist :id="type+'list'"></datalist>
          </form>
        </div>
        <div class="padding20">
          <template v-for="pill in selected">
            <div class="pill" :class="getBackClass()" @click="remove(pill)" :key="pill">
            <span v-text="pill"></span>
            <span class="red-text">&times;</span>
            </div>
          </template>
        </div>
      </div>`
  });


  var app = new Vue({
    el: '#meta-app',
    data: function () {
      return {
        'cy': null,
        'showAPIS': false,
        'showTags': false,
        'apisProcessed': false,
        'apisLoaded': false,
        'totalApis': 0,
        'hoverInfo': {}
      }
    },
    computed: {
      name: function () {
        return store.getters.getName
      },
      loading: function () {
        return store.getters.getLoading
      },
      apis: function () {
        return store.getters.getAPIS
      },
      operationsTotal: function () {
        return store.getters.getAPITotal
      },
      portal_info: function () {
        return store.getters.getHtml
      },
      results: function () {
        return store.getters.getResults
      },
      i_ac: function () {
        return store.getters.getI_AC
      },
      o_ac: function () {
        return store.getters.getO_AC
      },
      p_ac: function () {
        return store.getters.getP_AC
      },
      cyto_data: function () {
        return store.getters.getCytoData
      },
      spread: function () {
        return store.getters.getSpread
      },
      tagList: function () {
        return store.getters.getTagList
      },
      processes: function () {
        return store.getters.getProcesses
      },
    },
    watch: {
      apis: function (a) {
        var self = this;
        if (a.length) {
          self.apisProcessed = true;
        }
      },
      loading: function (isLoading) {
        var self = this;
        if (!isLoading) {
          //when done loading check URL for existing extra_params
          let base = window.location.origin + window.location.pathname
          let finalURL = window.location.href
          let url = new URL(finalURL);
          let params = new URLSearchParams(url.search.slice(1));

          var payload = {};
          payload["params"] = url.search.slice(1);
          store.commit('handleParams', payload);
        }
      },
      results: function () {
        var self = this;
        setTimeout(function () {
          self.createTips();
        }, 1000);
      }
    },
    methods: {
      allWithTag: function (name) {
        var payload = {};
        payload["highlight"] = name
        store.dispatch('allWithTag', payload)
      },
      allWithTagUndo: function (name) {
        store.dispatch('allWithTagUndo')
      },
      handleME: function (name) {
        var payload = {};
        payload["highlight"] = name
        store.dispatch('highlightThis', payload)
      },
      handleML: function (name) {

        var payload = {};
        payload["unhighlight"] = name
        store.dispatch('unhighlightThis', payload)
      },
      convertMarkdownToHtml: function (url, target) {
        // covert markdown from raw data url to html, and dump html in target
        axios.get(url).then(response => {

          var md = new Remarkable({
            html: true, // Enable HTML tags in source
            xhtmlOut: false, // Use '/' to close single tags (<br />)
            breaks: false, // Convert '\n' in paragraphs into <br>
            langPrefix: 'language-', // CSS language prefix for fenced blocks
            linkify: true, // Autoconvert URL-like text to links

            // Enable some language-neutral replacement + quotes beautification
            typographer: false,

            // Double + single quotes replacement pairs, when typographer enabled,
            // and smartquotes on. Set doubles to '«»' for Russian, '„“' for German.
            quotes: '“”‘’',

            // Highlighter function. Should return escaped HTML,
            // or '' if the source string is not changed
            highlight: function ( /*str, lang*/ ) {
              return '';
            }
          });
          var targetDump = document.getElementById(target);
          var html = md.render(response.data);
          targetDump.innerHTML = html;

        }).catch(err => {
          throw err;
        });


      },
      async loadKG() {
        var self = this;

        let meta_kg = new kg()
        //load meta-kg API graph with reasoner APIs
        const t0 = performance.now();
        await meta_kg.constructMetaKG(includeReasoner = true)
        const t1 = performance.now();
        self.apisLoaded = true;
        //performance check
        var seconds = (((t1 - t0) % 60000) / 1000).toFixed(0);
        console.log(`%c Getting Meta-KG graph took ${seconds} seconds.`, 'color:limegreen');

        var payl = {};
        payl["p"] = `Got Meta-KG graph in ${seconds} seconds.`;
        store.commit('addProcess', payl)
        //send graph data to store for processing
        var payload = {};
        payload["graph"] = meta_kg;
        store.commit('loadMetaKG', payload)

        self.drawCytoscape();
      },
      drawCytoscape() {
        //
        store.commit('drawGraph');
      },
      parseKGData() {
        var self = this;
        let data = [];

        if (self.ops) {

          for (var i = 0; i < self.ops.length; i++) {
            let node1 = { //a
              data: {
                id: self.ops[i]['association']['input_type']
              }
            };
            data.push(node1)

            let node2 = { //b
              data: {
                id: self.ops[i]['association']['output_type']
              }
            };
            data.push(node2)

            let edgeName = self.ops[i]['association']['api_name'] + ':' + self.ops[i]['association']['predicate']

            let edge = { // edge ab
              data: {
                id: edgeName + i,
                source: self.ops[i]['association']['input_type'],
                target: self.ops[i]['association']['output_type']
              }
            };
            data.push(edge)


          }
          console.log('data', data)
        }
      },
      reset() {
        store.commit('reset');
      },
      getClass(name) {
        switch (name) {
          case "MyGene.info API":
            return 'blue'
            break;
          case "MyChem.info API":
            return 'orange'
            break;
          case "MyVariant.info API":
            return 'green'
            break;
          default:
            return ''
        }
      },
      download() {
        store.dispatch('download');
      },
      highlightRow: function (item) {

        var self = this;

        self.hoverInfo = item

        var payload = {};
        payload['item'] = item
        store.dispatch('highlightRow', payload)
      },
      highlightRowAndZoom: function (item) {

        var self = this;

        self.hoverInfo = item

        var payload = {};
        payload['item'] = item
        store.dispatch('highlightRowAndZoom', payload)
      },
      unhighlightRow: function (item) {

        var payload = {};
        let edgeName = item['association']['api_name'] + ' : ' + item['association']['predicate'];
        payload["unhighlight"] = edgeName;
        payload['item'] = item;
        store.dispatch('unhighlightRow', payload)
      },
      loadExample() {
        store.commit('reset');

        var payload = {};
        payload["type"] = 'predicate';
        payload["q"] = 'treats';

        store.commit('pushPill', payload);

        var payload = {};
        payload["type"] = 'output_type';
        payload["q"] = "Disease";

        store.commit('pushPill', payload);

      },
      recenterGraph() {
        store.dispatch('recenterGraph')
      },
      checkforQuery: function () {
        var self = this;
        var url_string = window.location.href
        var url = new URL(url_string);

        var q = url.searchParams.get("q");
        if (q) {
          this.query = q;
        }

        var tags = url.searchParams.get("tags");
        if (tags) {
          if (tags.includes(',')) {
            tags = tags.split(',')
          } else {
            tags = [tags]
          }
          for (var i = 0; i < tags.length; i++) {
            for (var x = 0; x < self.tags.length; x++) {
              if (self.tags[x].name === tags[i]) {
                var payload = {};
                payload["tag"] = self.tags[x];
                store.commit('toggleTag', payload);
              }
            }
          }
        }

        var owners = url.searchParams.get("owners");
        if (owners) {
          if (owners.includes(',')) {
            owners = owners.split(',')
          } else {
            owners = [owners]
          }
          for (var i = 0; i < owners.length; i++) {
            for (var x = 0; x < self.authors.length; x++) {
              if (self.authors[x].name === owners[i]) {
                var payload = {};
                payload["author"] = self.authors[x];
                store.commit('toggleAuthor', payload);
              }
            }
          }
        }

      },
      copy() {
        Swal.fire({
          type: 'success',
          toast: true,
          title: 'Copied',
          showConfirmButton: false,
          timer: 1000
        });
      },
      createTips() {
        var self = this;

        tippy(".resultInfo", {
          trigger: 'click',
          placement: 'top-start',
          interactive: true,
          animation: 'fade',
          theme: 'light',
          onShow(instance) {
            if (self.hoverInfo) {
              // hover item info saved to state
              let info = self.hoverInfo
              let desc = ""
              let status = "N/A"

              axios.get("/api/query?size=1&q=_id:"+info.association.smartapi.id+"&fields=info.description,_meta.uptime_status").then(res=>{
                console.log(res.data);

                desc = res.data.hits[0]['info']['description'].substring(0,400)+'...';
                status = res.data.hits[0]['_meta']['uptime_status']

                instance.setContent(`<div>
                <h6>API: <a target="_blank" href="/registry?q=` + info.association.smartapi.id + `">` + info
                .association.api_name + `</a></h6>
                <p><small>`+desc+`<a target="_blank" href="/registry?q=` + info.association.smartapi.id + `">Learn More</a></small></p>
                <b><small>API Status: `+status+`</small></b>
                <table>
                  <tbody>
                    <tr class="grey lighten-4">
                      <td>
                        <small class="grey-text">INPUT/ID TYPE</small>
                      </td>
                      <td>
                        <small>` + info.association.input_type + `/` + info.association.input_id + `</small>
                      </td>
                    </tr>
                    <tr class="purple lighten-4">
                      <td>
                        <small class="purple-text">RELATIONSHIP</small>
                      </td>
                      <td>
                        <small>` + info.association.predicate + `</small>
                      </td>
                    </tr>
                    <tr class="orange lighten-4">
                      <td>
                        <small class="orange-text">OUTPUT/ID TYPE</small>
                      </td>
                      <td>
                        <small>` + info.association.output_type + `/` + info.association.output_id + `</small>
                      </td>
                    </tr>
                  </tbody>
                </table>
                </div>`)

              }).catch(err=>{
                throw err;
                instance.setContent(`<div>
                <h6>API: <a target="_blank" href="/registry?q=` + info.association.smartapi.id + `">` + info
                .association.api_name + `</a></h6>
                <p><small>`+desc+`</small></p>
                <table>
                  <tbody>
                    <tr class="grey lighten-4">
                      <td>
                        <small class="grey-text">INPUT/ID TYPE</small>
                      </td>
                      <td>
                        <small>` + info.association.input_type + `/` + info.association.input_id + `</small>
                      </td>
                    </tr>
                    <tr class="purple lighten-4">
                      <td>
                        <small class="purple-text">RELATIONSHIP</small>
                      </td>
                      <td>
                        <small>` + info.association.predicate + `</small>
                      </td>
                    </tr>
                    <tr class="orange lighten-4">
                      <td>
                        <small class="orange-text">OUTPUT/ID TYPE</small>
                      </td>
                      <td>
                        <small>` + info.association.output_type + `/` + info.association.output_id + `</small>
                      </td>
                    </tr>
                  </tbody>
                </table>
                </div>`)
              });
              
            }
          }
        });
      }

    },
    created: function () {
      if ({{Context}}) {
        var payload = {};
        payload["context"] = {{Context}};
        store.commit('saveContext', payload);
      }

    },
    mounted: function () {
      var self = this;
      if (self.name == 'translator') {
        self.loadKG();

        let payload = {}
        payload['loading'] = true;
        store.commit('toggleLoading', payload)

      }

      new ClipboardJS('.copyBtn');
      ClipboardJS.isSupported();

    }
  });
</script>
{% endblock %}