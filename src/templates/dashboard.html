{% extends "main.html" %}
{% include "smartapi-head.html" %}
{% block content %}
{% include "header.html" %}
{% raw %}
<main id="dashApp" style="padding-top:20px;min-height:90vh;" class="blue-grey darken-3" v-cloak>
  <!-- IF NO USER INFO DISPLAY LOGIN-->
  <div v-if="!userInfo.login" class="padding20 card-panel white center-align">
    <h5 class="text_h3 blue-grey-text-text">
      You Must Be Signed In To Use Your Dashboard
    </h5>
    <a href="/oauth" class="btn green">
      Login
    </a>
  </div>
  <!-- LOADING -->
  <div id="loading-overlay" class="center-align" style="background-color: rgba(18, 52, 84, 0.5); cursor: default;">
    <div class="center-align" style="padding-top: 300px;">
      <object width="100px"  alt="Loading" data="/static/img/fly.gif" class=""></object>
      <h3 class="white-text logoFont">Loading...</h3>
    </div>
  </div>
  <!-- Loading END -->
  <!-- IF USER INFO DISPLAY DASHBOARD -->
  <div id="tippyParent" v-if="userInfo.login" class="row" style="margin-bottom: 0; width: 100%;min-height:70vh;">
      <div class="col s12 m4 l3 xl3 transparent">
        <ul class="collection" style="border: none;">
          <li class="collection-item center-align transparent" style="border-bottom: none;">
            <img v-if="userInfo.avatar_url" id="dashboardPhoto" width="70%" :src="userInfo.avatar_url" class="responsive-img hideOnSmall hide-on-med-and-down" alt="user image" style="box-shadow: 5px 5px 5px #273238; margin-bottom: -25px; border-radius: 10px; border: 2px white solid; max-width:250px;">
            <img v-else id="dashboardPhoto" width="70%" src="/static/img/user-default.png" class="responsive-img hideOnSmall" alt="user image" style="box-shadow: 5px 5px 5px #273238; margin-bottom: -25px; border-radius: 10px; border: 2px white solid; max-width:250px;">
          </li>
          <li class="collection-item center-align white-text padding20 blue" style="border-top-left-radius: 10px; border-top-right-radius: 10px;">
            <img v-if="userInfo.avatar_url" width="30%" :src="userInfo.avatar_url" class="show-on-medium-and-down hide-on-med-and-up circle" alt="user image" style="margin: 0 auto; border: 3px solid white;">
            <h5 v-if="userInfo.name" class="text_h3 white-text textShadow swing-in-top-fwd">Hello, {{ userInfo.name.split(" ")[0] }}!</h5>
            <h5 v-else class="text_h3 white-text textShadow swing-in-top-fwd">Hello, {{ userInfo.login }}!</h5>
            <p><a target="_blank" class="white-text" :href="'https://github.com/'+userInfo.login"><i class="tiny fa fa-github-alt white-text"></i> {{userInfo.login}}</a></p>
          </li>
          <!--  -->
          <li class="collection-item center-align blue-grey darken-4 white-text show-on-small hide-on-med-and-up">
            <span class="logoFont blue-grey-text">SmartAPI</span><br />CONTRIBUTIONS <span class="l-blue-text">({{ total+") API's" }}</span>
          </li>
          <li class="collection-item blue-grey-text hide-on-small-only">
            <h5 class="center">APIs</h5>
            <h5 class="center blue-text"> {{ total}}</h5>
            <div class="center">
              <a href="/logout" class="btn red smallFont">Log Out</a>
            </div>
          </li>
        </ul>
      </div>
    <div class="col s12 m8 l9 xl9 center-align">
        <div class="row">
          <div class="p-1 col s12">
            <input v-model='searchQuery' placeholder="Search by API name" type="text" class="browser-default margin20 blue-grey darken-3 l-blue-text lighter" style="width: 40%; outline: none; padding: 10px; border-radius: 20px; border:var(--blue-light) 2px solid;"/>
          </div>
          
          <div class="col s12">
            <ul class="tabs transparent">
              <li class="tab col s3 transparent">
                <a class="white-text textShadow " href="#contributions">
                  APIs <span class="l-blue-text">({{total}})</span>
                </a>
              </li>
            </ul>
          </div>

          <div id="contributions" class="col s12 card-panel" style="padding:0;">
              <div class="s12">
                <ul class="collection resultsContainer">
                  <li class="collection-item" v-for="(api,index) in results" style="margin-bottom:0px;padding: 0px;">
                    <div class="row" style="padding: 0px; margin-bottom:0px;">
                      <div class="col s12 row" style="padding: 0px; 
                      margin-bottom:0px;
                      display: flex;
                      align-items: center;
                      flex-wrap: wrap;">
                        <div class="col s6 m3 p-1">
                          <a href="#modal2" class="modal-trigger" @click="getDetails(index)">
                            <h6><b>{{ api.info.title }}</b></h6>
                          </a>
                          <small>
                            <span class="grey-text smallFont">V.{{api.info.version}}</span>
                          </small>
                        </div>
                        <div class="col s6 m3 p-1">
                          <h6>
                            <small class="grey-text"><i class="fa fa-clock-o" aria-hidden="true"></i> Last Updated </small>
                          </h6>
                          <small>
                            <span class="green-text"> {{ convertDate(api._meta.last_updated) }}</span>
                          </small>
                        </div>
                        <div class="col s4 m2 p-1">
                          <refresh :refresh='refreshingThis' :title='api.info.title' :id="api._id" 
                          data-tippy-content="<b class='green-text'>Refresh</b> <br/>(Manually update API metadata when a valid change is detected)"></refresh>
                        </div>
                        <div class="col s4 m2 p-1">
                          <button type="button" @click="validate(api._meta.url)" class="btn btn-small scale-in-center indigo white-text" 
                          data-tippy-content="<b class='indigo-text'>Validate Only</b> <br/>(Validate latest API metadata from the source URL)">
                            <i class="material-icons white-text">check</i>
                        </button>
                        </div>
                        <div class="col s4 m2 p-1">
                          <a href="#modal1" @click="deleteAPI(api.info.title, api._id)" class="btn btn-small scale-in-center red white-text modal-trigger" 
                          data-tippy-content="<b class='red-text'>Delete</b> <br/>(Delete API metadata from SmartAPI registry permanently - cannot be undone)">
                            <i class="material-icons white-text">delete_forever</i>
                          </a>
                        </div>
                      </div>
                      <div class="col s12 row" style="padding: 0px; margin-bottom:0px;background-color: rgba(0, 0, 0, .05);">
                        <div class="col s6 m3">
                          <a href="#" class='popularity pointer blue-text' :data-tippy-name='api.info.title' :data-tippy-id='api._id'>
                            <small><i class="fa fa-bar-chart"></i> User Interactions</small>
                          </a>
                        </div>
                        <div class="col s6 m3">
                          <small>Specification </small>
                          <span v-if=" api.hasOwnProperty('openapi') " class="smallFont badge green white-text" data-tippy-content="<b class='green-text'>OpenAPI 3</b> Specification">
                            OAS3
                          </span>
                          <span v-else-if=" api.hasOwnProperty('swagger') " class="smallFont badge blue white-text" data-tippy-content="<b class='blue-text'>Swagger 2</b> Specification">
                            Swagger2
                          </span>
                        </div>
                        <div class="col s6 m3">
                          <small>API Status </small> <status :api='api'></status>
                        </div>
                        <div class="col s6 m3">
                          <small>Source Status </small>
                          <source-status :api='api'></source-status>
                        </div>
                      </div>
                    </div>
                  </li>
                  <div v-if="apis.length === 0">
                    <small class="center-align grey lighten-3">
                      <span class="grey-text smallFont">No Contributions Yet</span><br>
                    </small>
                  </div>
                </ul>
              </div>
          </div>

        </div>
    </div>
  </div>
  <div class="grey lighten-5 padding20 blue-text center">
      <small>
        <i class="material-icons">error_outline</i> Did you know you can set a custom slug for your API's documentation? It's easy! Just click on any API on your dashboard and go to the <em>Settings</em> tab.<br />
        Use the <em>Custom Slug Registration Wizard</em> and get a custom URL for your API's documentation. E.g. <b>&lt;slug&gt;.smart-api.info</b>
      </small>
  </div>
  <!-- Modal for Deletion Confirmation -->
  <div id="modal1" class="modal center-align">
    <div class="modal-content">
      <h5 class="blue-text">Delete <b>{{ confirmModal.title }}</b>?</h5>
      <div class="white padding20">
        <i class="material-icons small amber-text">warning</i>
        <p class="red-text">This action cannot be undone. Please type in the exact name of the API to confirm.</p>
        <input v-model="inputApiName" :placeholder="confirmModal.title" type="text" class="validate browser-default" style="outline: none; padding: 10px; width: 70%;">
        <hr/>
        <a href='#!' :disabled="confirmDelete" @click="deleteForever(confirmModal.title, confirmModal.id)" class=" deep-orange darken-2 btn modal-action modal-close">Delete API</a>
      </div>
      <hr>
      <a href="#!" class="btn blue modal-action modal-close">Cancel</a>
    </div>
  </div>
  <!-- delete Modal end -->


  <!-- Details Modal -->

  <div id="modal2" class="modal center-align">
    <div  class="modal-content" style="padding-top:45px;">
      <div class="row">
        <div class="col s12">
          <ul class="tabs transparent">
            <li class="tab col s3"><a href="#test1" class="active blue-text">About</a></li>
            <li class="tab col s3"><a class="blue-text" href="#test2"><i class="tiny material-icons">settings</i> Settings</a></li>
          </ul>
        </div>

        <div id="test1" class="col s12">
          <ul v-if="selectedAPIIndex || selectedAPIIndex === 0" class="collection with-header" style="border: none;">

            <li class="collection-header padding20">
              <object width="100px"  alt="SmartAPI" data="/static/img/logo-medium.svg" class="hide-on-small-only"></object>
              <h2 class="blue-text flow-text">
                {{apis[selectedAPIIndex].info.title}}
                <span class="versionBadge grey hide-on-small-only">Version {{apis[selectedAPIIndex].info.version}}</span>
                <span v-if=" apis[selectedAPIIndex].hasOwnProperty('openapi') " class="versionBadge green hide-on-small-only">
                  OAS3
                </span>
                <span v-else-if=" apis[selectedAPIIndex].hasOwnProperty('swagger') " class="versionBadge blue hide-on-small-only">
                  Swagger2
                </span>
                <template class="show-on-small hide-on-med-and-up">
                  <span v-if=" apis[selectedAPIIndex].hasOwnProperty('openapi') " class="versionBadge green hide-on-med-and-up">
                    V3
                  </span>
                  <span v-else-if=" apis[selectedAPIIndex].hasOwnProperty('swagger') " class="versionBadge blue hide-on-med-and-up">
                    V2
                  </span>
                </template>
              </h2>
              <hr />
              <template v-if=" apis[selectedAPIIndex].hasOwnProperty('swagger') ">
                <div class="yellow lighten-5 smallFont padding20">
                  APIs in Swagger V2 specification will experience limited functionality. <br />We recommend you update your metadata to OpenAPI V3 specification.
                  <br />
                  <a target="_blank" class="underlined" href="https://github.com/SmartAPI/smartAPI-Specification/blob/OpenAPI.next/versions/3.0.0.md">Learn More about OpenAPI V3 Specification <i class="fa fa-external-link-square" aria-hidden="true"></i></a>
                  <br />
                  <a href="/guide" class="green-text underlined">Use our guide to help you convert your API to OpenAPI V3 specification.</a>
                </div>
                <hr />
              </template>
              <a :href="'/ui/'+apis[selectedAPIIndex]._id" class="btn blue">View API Doc</a>
            </li>
            <template v-for='link in checkForAPIInfoLink(apis[selectedAPIIndex])'>
              <li  class="collection-item blue-grey lighten-4">
                <a class="link blue-grey-text underlined" :href="link" target="_blank">
                 More Info
                </a>
              </li>
            </template>
            <li class="collection-item padding20 blue-grey lighten-5">
              <p style="line-height: 1.2em;" class="blue-grey-text flow-text" v-html="compiledMarkdown(apis[selectedAPIIndex].info.description || '')"></p>
            </li>
            <li class="collection-item blue-grey lighten-5">
              <i v-if="apis[selectedAPIIndex].info.termsOfService || apis[selectedAPIIndex].termsOfService" class="material-icons tiny blue-text">info_outline</i>
              <a v-if="apis[selectedAPIIndex].info.termsOfService" :href="apis[selectedAPIIndex].info.termsOfService" target="_blank" class="blue-text">Terms of Service</a>
              <a v-if="apis[selectedAPIIndex].termsOfService" :href="apis[selectedAPIIndex].termsOfService" target="_blank" class="blue-text">Terms of Service</a>

            </li>
          </ul>
        </div>

        <div id="test2" class="col s12 white">
          <div v-if="selectedAPIIndex || selectedAPIIndex === 0" class="row">
            <div class="col s12 m12 l12 center-align">
              <h3 class="flow-text blue-grey-text padding20">Slug Registration Wizard</h3>
            </div>
            <div v-if='!hasShortName' class="col s12 m12 l12 center-align">
              <object class="hide-on-small-only" width="250px" data="/static/img/wand.svg" alt='custom slug' style='border-radius: 10px;'></object>
              <p class="grey-text left-align">
                Every project has a subdomain that is available to serve its documentation.<br />
                By default we use your <i>API ID</i>. If you go to <span class="blue-text"><b>your-api-id</b>.smart-api.info</span> it should allow users to view your API documentation.
              </p>
              <p class="grey-text left-align">
                You can also register a unique slug to make sharing your API easier.
                <br />
                If you go to <span class="blue-text"><b>your-slug</b>.smart-api.info</span>, it will take users to your API documentation.
              </p>
              <a v-if='!createOrEditMode' @click.prevent='createOrEditMode = !createOrEditMode' class="blue btn">Create a new slug</a>
              <a v-if='createOrEditMode' @click.prevent='createOrEditMode = !createOrEditMode' class="red btn">Cancel</a>
            </div>
            <div v-if='hasShortName' class="col s12 m12 l12">
              <p>
                <i class="fa fa-check-circle-o green-text fa-5x" aria-hidden="true"></i>
              </p>
              <p class="grey-text">
                You have registered your custom slug!
                <br />
                If you visit to link below, it will take users to your API documentation.
              </p>
              <p class="green-text flow-text">
                 <a :href=" 'http://'+apis[selectedAPIIndex]._meta.slug+'.smart-api.info'" target="_blank" class="green-text link">http://<b>{{apis[selectedAPIIndex]._meta.slug}}</b>.smart-api.info <i class="fa fa-external-link-square" aria-hidden="true"></i></a>
                 <br />
                 <hr />
                 <a class="btn green smallFont margin20" @click.prevent='createOrEditMode = !createOrEditMode'>Edit Slug</a>
                 <a v-if="hasShortName" class="btn red smallFont margin20" @click.prevent='deleteSlug'>Delete Slug</a>
              </p>
            </div>
            <div v-if="createOrEditMode" style="width: 100%; display: flex; align-items: center;justify-content: center; flex-wrap: wrap;">
              <div class="left-align padding20 grey-text" style="flex: 1; min-width: 100%;">
                Slug length must be 4-50 characters (a-z) and/or numbers (0-9). Slugs will be converted to lower case. URL protected characters not allowed.
              </div>
              <div style="flex: 1; min-width: 200px;">
                <input autocomplete="false" v-model='myShortName' placeholder="Enter your slug here" id="first_name" type="text" class="disabled browser-default margin20 grey lighten-5 blue-grey-text lighter" style="width: 85%; outline: none; padding: 10px; border-radius: 20px; border:var(--blue-medium) 2px solid;">
              </div>
              <div style="flex: 1; min-width: 200px;">
                <p id="availabilityResults" v-bind:class="{'green-text': availableShortName, 'red-text': !availableShortName }">
                  <span v-if="myShortName" class="grey-text">http://</span>
                  <span v-if="myShortName">{{myShortName}}</span>
                  <span v-if="myShortName" class="grey-text">.smart-api.info</span>
                  <span v-if="!myShortName" class="grey-text">Check Slug Availability</span>
                  <i v-if='availableShortName && myShortName' class="fa fa-thumbs-up green-text" aria-hidden="true"></i>
                  <i v-if='!availableShortName && myShortName' class="fa fa-thumbs-down red-text" aria-hidden="true"></i>
                  <br />
                  <span v-if="myShortName.length <= 3 && myShortName.length > 0" class="amber-text"><i class="tiny material-icons">warning</i> Too Short</span>
                  <span v-if="myShortName.length >50" class="orange-text"><i class="tiny material-icons">warning</i> Too Long</span><br v-if="myShortName.length <= 3 && invalidChars"/>
                  <span v-if="invalidChars" class="red-text"><i class="tiny material-icons">warning</i> Invalid Characters</span>
                  <span v-if="takenSlug" class="orange-text"><i class="tiny material-icons">warning</i> Taken Slug</span>
                </p>
              </div>
              <div style="flex: 1; min-width: 200px;">
                <a @click.prevent="setShortname" :disabled='!availableShortName && !hasShortName' :class="!availableShortName ? 'btn grey' : 'green btn pulse' " >Set Slug</a>
              </div>

              <div id="shortNameSuccess" class="center-align padding20 green smallFont" style="flex: 1; min-width: 100%; display: none;">
                <h5 class="white-text"><i class="fa fa-check white-text" aria-hidden="true"></i> Slug Registered</h5>
                <a href="#!" class="btn green modal-action modal-close">Close</a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <a href="#!" style="position: absolute; top:1%; right: 5%; font-size: 2em;" class="red-text modal-action modal-close">&times;</a>
    </div>
  </div>


</main>


{% endraw %}
{% include "footer.html" %}
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/vuex"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.6/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script src="https://unpkg.com/tippy.js@3/dist/tippy.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
<script src="/static/js/moment.js"></script>


<script>

const store = new Vuex.Store({
    state: {
      'analytics':Object,
      'tags':Array
    },
    strict: true,
    mutations: {
      saveAnalytics(state,payload){
        state.analytics = payload['analytics'];
      },
    },
    getters:{
      // exposed as store.getters.nameOfGetter
      getHitsFor: (state) => (apiname) => {
        let data={'labels':[],'datasets':[]};
        let label = '';
        let dataArray=[];

        for (var i = 0; i < state.analytics.length; i++) {
          if (state.analytics[i][1].toLowerCase() === apiname.toLowerCase()) {
            label = state.analytics[i][0].toUpperCase();
            if (label == "EXPANDED") {
              label = "VIEWS"
            }
            data.labels.push(label);
            let number = state.analytics[i][2];
            dataArray.push(number)
          }

        }
        data.datasets.push({'label':"Users",'data':dataArray,'backgroundColor': ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850"],})
        // console.log('user interactions...',data)
        return data
      },
      getTags:(state)=>{
        let pop = []
        for (var i = 0; i < state.analytics.length; i++) {
          if (state.analytics[i][0] ==='tag') {
            pop.push({'name':state.analytics[i][1],'active':false,'count':state.analytics[i][2]})
          }
        }
        return pop;
      }

    }
  });

Vue.component('status', {
  data: function(){
    return{
      status:'',
      clss:'',
    }
  },
  props: ['api'],
  methods:{
    getStatus(api){
      let self = this;
      if (api.hasOwnProperty('_status') && api['_status'].hasOwnProperty('uptime_status')) {
        let stat = api['_status']['uptime_status'];
        switch (stat) {
          case 'unknown':
            self.status = 'UNKNOWN';
            self.clss = 'orange';
            break;
          case 'good':
            self.status = 'PASS';
            self.clss = 'green';
            break;
          case 'bad':
            self.status = 'BAD';
            self.clss = 'red';
            break;
          case 'incompatible':
            self.status = 'INCOMPATIBLE';
            self.clss = 'blue';
            break;
          default:
          self.status = 'N/A';
          self.clss = 'grey';
        }
      }else{
        self.status = 'N/A';
        self.clss = 'grey';
      }
    },
  },
  mounted: function(){
    this.getStatus(this.api);
  },
  template: `<span class="badge apiStatus white-text" :class='clss' v-text="status"></span>`
});

Vue.component('source-status', {
  data: function(){
    return{
      status:'',
      clss:'',
    }
  },
  props: ['api'],
  methods:{
    getStatus(api){
      let self = this;
      if (api.hasOwnProperty('_status') && api['_status'].hasOwnProperty('refresh_status')) {
        let stat = api['_status']['refresh_status'];
        switch (stat) {
          case 200:
            self.status = "OK";
            self.clss = 'green';
            break;
          case 299:
            self.status = "OK";
            self.clss = 'green';
            break;
          case 499:
            self.status = "INVALID";
            self.clss = 'red';
            break;
          case 599:
            self.status = "BROKEN";
            self.clss = 'purple';
            break;
          case 404:
            self.status = "NOT FOUND";
            self.clss = 'orange';
            break;
          default:
          self.status = stat;
          self.clss = 'black';
        }
      }else{
        self.status = 'N/A';
        self.clss = 'grey darken-1';
      }
    },
  },
  mounted: function(){
    this.getStatus(this.api);
  },
  template: `<span class="badge urlStatus white-text" :class='clss' v-text="status"></span>`
});


  // Refresh Button Component
  Vue.component('refresh', {
    data: function(){
      return{
        //timeout before being able to refresh again
        counter:30,
        //bind to disable attr while waiting
        currentlyRefreshing: false,
        text: 'refresh'
      }
    },
    // declare the props
    props: ['refresh', 'title', 'id'],
    // like data, the prop can be used inside templates and
    // is also made available in the vm as this.message
    methods:{
      countDown: function(){
        this.counter --;
        if( this.counter > 0 ){
          setTimeout(this.countDown,1000);
          this.currentlyRefreshing = true;
          this.text =this.counter+'...';
          var thisElement =$(this.$el);
          thisElement[0].text=this.text;
        }
        else if ( this.counter === 0){
          this.currentlyRefreshing = false;
          this.counter = 30;
          this.text = `<i class=" material-icons white-text"  @mouseenter="$event.target.classList.add('rotate')" @mouseleave="$event.target.classList.remove('rotate')">refresh</i>`;
          var thing =$(this.$el);
          thing[0].innerHTML=this.text;
        }
      },
      getText: function(){
        return this.text;
        //console.log(this.text);
      }
    },
    mounted: function(){
      // mounted logic
      tippy('[data-tippy-content]',{
        placement: 'top',
        theme:'light',
        onShow(instance) {
          let msg = instance.reference.dataset.tippyContent;
          instance.setContent('<div style="padding:5px;"><h6 class="blue-text">'+msg+'</h6></div>')
        },
      });
    },
    template: `<a class="btn btn-small" :disabled='currentlyRefreshing' @click="refresh(title,id); countDown()" :class="currentlyRefreshing ? 'grey' : 'green scale-in-center' ">
                <i class=" material-icons white-text">refresh</i>
              </a>`
  });

  // Main Dashboard Component
    var app = new Vue({
        el: '#dashApp',
        data: function(){
          return {
            userInfo:{},
            confirmModal:{
              title:'',
              id:''
            },
            selectedAPI:{},
            inputApiName:'',
            apis:[],
            total: 0,
            confirmDelete: true,
            searchQuery:'',
            searchResults:[],
            sortASC: true,
            myShortName:'',
            availableShortName: false,
            hasShortName: false,
            createOrEditMode: false,
            invalidChars: false,
            takenSlug: false,
            selectedAPIIndex:''
          }
        },
        computed:{
          results: function(){
            return this.searchResults.length ? this.searchResults : this.apis;
          }
        },
        methods:{
          validate(url){
            let self = this;
            if (url) {
              axios.post('/api/validate',{'url':url}).then(res=>{
                console.log(res.data)
                swal({
                    imageUrl: '/static/img/api-sucess.svg',
                    imageWidth: 300,
                    title: 'Great! Everything looks good!',
                  })
              }).catch(err=>{
                if(err.hasOwnProperty('response') && err.response.hasOwnProperty('data')){
                // console.log('[Error]:', err.response)
                if(err.response.data.hasOwnProperty('error') && err.response.data.error == "Conflict"){
                swal({
                  title: "Wait a second...",
                  html:'<h3>Looks like this API already exists</h3><p>If you are the owner of this API you can refresh it via the <a href="/dashboard">user dashboard</a></p>',
                  imageUrl: '/static/img/api-overwrite.svg',
                  imageWidth: 300,
                  confirmButtonText: 'OK',
                });
              }
              else if(err.response.data.hasOwnProperty('details') && err.response.data.details == "API exists"){
                swal({
                  title: "Wait a second...",
                  html:'<h3>Looks like this API already exists</h3><p>If you are the owner of this API you can refresh it via the <a href="/dashboard">user dashboard</a></p>',
                  imageUrl: '/static/img/api-fail.svg',
                  imageWidth: 300,
                  confirmButtonText: 'OK',
                });
              }
              else if(err.response.data.hasOwnProperty('details') && err.response.data.details.includes("Validation Error")){
                swal({
                  title: "Oh no, there's a problem!",
                  imageUrl: '/static/img/api-fail.svg',
                  imageWidth: 300,
                  confirmButtonText: 'OK',
                  html:`<h5>Here's what we found:</h5>
                        <div class="padding20 orange lighten-5 codeBox"><code>`+err.response.data.details || err.response.data+`</code></div>`,
                  footer:`<p><b class="red-text">Need help?</b> Take a look at OpenAPI specification examples <a href="https://github.com/NCATSTranslator/translator_extensions" target="_blank" rel="nonreferrer">here</a>.</p>`
                })
              }
              else{
                swal({
                  title: "Oops, there's an issue!",
                  imageUrl: '/static/img/api-fail.svg',
                  imageWidth: 300,
                  confirmButtonText: 'OK',
                  html:`<h5>Here's what we found:</h5>
                        <div class="padding20 orange lighten-5 codeBox"><code>`+err.response.data.details || err.response.data+`</code></div>`,
                  footer:`<p><b class="red-text">Need help?</b> Learn more about and look at examples of SmartAPI extensions <a href="https://github.com/NCATSTranslator/translator_extensions" target="_blank" rel="nonreferrer">here</a>.</p>`
                })
              }
              }
              });
            } else {
              Swal.fire({type:'error',
                toast:true,
                title: 'Missing URL',
                showConfirmButton:false,
                timer:1000})
            }
          },
          getDetailsSearch(apiInfo){
            for (var i = 0; i < this.apis.length; i++) {
              if (this.apis[i]._id === apiInfo._id) {
                this.selectedAPIIndex = i;
              }
            }
          },
          getApis: function(){
            var self=this;
            self.apis=[];
            var params = {
                "params": {
                    'fields': 'info,_meta,tags,openapi,swagger,'
                }
            };
            axios.get("/api/query?size=100&q=_meta.username:"+self.userInfo.login,params).then(function(response){
                  self.apis = response.data.hits;
                  self.total = response.data.total;
                  self.hideLoading();
              }).catch(err=>{
                const toast = swal.mixin({
                  toast: true,
                  position: 'top',
                  showConfirmButton: false,
                  timer: 2000
                });
                self.hideLoading();

                toast({
                  type: 'error',
                  title: 'Failed to load APIS'
                })
                throw err;
              });

          },
          compiledMarkdown: function (mdtext) {
              return marked(mdtext, { sanitize: true })
          },
          deleteAPI: function(title, id){
            // api information sent to modal for confirmation to be deleted
            var self = this;
            self.confirmModal.title= title;
            self.confirmModal.id = id;
          },
          deleteForever: function(title, apiID){
            // ID for api to be deleted forever
            var self = this;
            self.showLoading();
            axios.delete('/api/metadata/'+apiID).then(response=>{
              //sucessful deletion
              self.hideLoading();
              if( response.data.success ){
                const toast = swal.mixin({
                  toast: true,
                  position: 'top',
                  showConfirmButton: false,
                  timer: 2000
                });

                toast({
                  type: 'success',
                  title: title+' was deleted!'
                })
                self.apis=[];
                self.getApis();
              }else if( !response.data.success ){
                const toast = swal.mixin({
                  toast: true,
                  position: 'top',
                  showConfirmButton: false,
                  timer: 2000
                });

                toast({
                  type: 'error',
                  title: 'Failed to delete '+title
                })
              }
            }).catch(error=>{
              //error deleting
              throw(error);
            });
            self.getApis();

          },
          showMessage(title, status){
            const toast = swal.mixin({
                  toast: true,
                  position: 'top',
                  showConfirmButton: false,
                  timer: 4000
                });
            switch (status) {
              case 'updated':
                swal({
                  title: "Sweet!",
                  confirmButtonText: 'OK',
                  imageUrl: '/static/img/api-sucess.svg',
                  imageWidth: 200,
                  html: "<h5><b>"+title+"</b> was updated!</h5>",
                  footer: "<p>You may look at your latest changes on our <a href='/registry?q="+title+"'>API registry</a>.</p>"
                })
                break;

              case 'not_modified':
                swal({
                  title: "Hmmm...",
                  imageUrl: '/static/img/api-thinking.svg',
                  imageWidth: 200,
                  confirmButtonText: 'OK',
                  html: "<h5><b>"+title+"</b> has no changes.</h5>",
                  footer: "<p>If this doesn't sound right, wait a few minutes and try again. Repositories such as GitHub may have a delay updating their raw data.</p>"
                })
                break;

              case 'invalid':
                swal({
                  title: "Oops!",
                  confirmButtonText: 'OK',
                  imageUrl: '/static/img/api-fail.svg',
                  imageWidth: 200,
                  confirmButtonText: 'OK',
                  html: "<h5 class='red-text'>New version found but there's validation errors.</h5>",
                  footer: "<p>Try loading your newest version into this <a href='/editor'>editor</a>, or try to add as a new API to see detailed validation error.</p>"
                })
                break;

              case 'nofile':
                swal({
                  title: "Oh no!",
                  confirmButtonText: 'OK',
                  imageUrl: '/static/img/api-error.svg',
                  imageWidth: 200,
                  html: "<h6 class='red-text'>Looks like the source file no longers exists or is not reachable</h6>",
                  footer: "<p>This issue can only be resolved by restoring your source file or deleting this API and re-registering as a new API with a working source file.</p>"
                })
                break;
            
              default:
                toast({
                    title: 'NAME: <b>' + title + '</b> - STATUS: ' + status
                  })
                break;
            }
          },
          refreshingThis: function(title, id){
            var self = this;
            self.showLoading();
            axios.put('/api/metadata/'+id).then(res=>{
              if( res.data.success ){
                self.showMessage(title, res.data.status)
                self.hideLoading();
              }else if( !res.data.success ){
                self.showMessage(title, res.data.status)
                self.hideLoading();
              }
            }).catch(err=>{
              if (err.response.data.hasOwnProperty('status')) {
                self.showMessage(title, err.response.data.status)
              } else {
                toast({
                  type: 'error',
                  title: title+' failed to refresh'
                })
              }
              self.hideLoading();
              throw(err);
            });
            self.getApis();
          },
          showLoading: function(){
            $('#loading-overlay').show();
          },
          hideLoading: function(){
            $('#loading-overlay').hide();
          },
          sortApisByName: function(){
            var self = this;
            self.sortASC = !self.sortASC;
            //var sortedAPIS = _.sortBy(self.apis,'info.title');
            //return sortedAPIS;
          },
          getDetails: function(index){
            var self = this;
            //modal will show the apis index of the item clicked
            self.selectedAPIIndex = index;
            //hasShortName sets display for slug registration view
            if (self.apis[index]._meta.slug) {
              self.hasShortName=true;
            }else{
              self.hasShortName=false;
            }
          },
          checkForAPIInfoLink: function(api){
            // console.log(api);
            if (_.get(api, 'info.contact.x-id')) {
              return [api.info.contact['x-id']];
            }
            else if (_.get(api, 'info.contact.url')) {
              return [api.info.contact.url];
            }
            else{
              return ['http://smart-api.info/'];
            }
          },
          convertDate: function(timestamp){
            var date = new Date(timestamp);
            date = moment(date).format('LLL');
            return date;
          },
          reloadAPIs: function(){
            this.showLoading();
            this.getUserInfo();
          },
          evaluateShortname: function(){
            var self = this;
            axios.get(`/api/query?q=__all__&filters={"_meta.slug":["`+this.myShortName+`"]}&fields=_meta`).then(response=>{
              //console.log(response.data.hits);
              if (response.data.total.value) {
                self.availableShortName = false;
                self.takenSlug = true;
                return false;
              }else{
                self.availableShortName = true;
                self.takenSlug = false;
                return true;
              }
            }).catch(error =>{
              throw error;
              self.availableShortName = false;
              Materialize.toast('Slug check failed', 4000,'rounded red white-text');
            })

          },
          setShortname: function(){
            //claim it button clicked
            var self = this;
            $('#loadingCog').hide();
            axios.put('/api/metadata/'+self.apis[self.selectedAPIIndex]._id+'?slug='+self.myShortName).then(response=>{
              if( response.data.success ){
                self.apis[self.selectedAPIIndex]._meta.slug= response.data[self.apis[self.selectedAPIIndex]._id+'._meta.slug'];
                self.myShortName = '';

                const toast = swal.mixin({
                  toast: true,
                  position: 'top',
                  showConfirmButton: false,
                  timer: 2000
                });

                toast({
                  type: 'success',
                  title:'Slug was registered'
                })

                self.createOrEditMode = false;
                self.hasShortName = true;
                $('#loadingCog').show();
              }else if( !response.data.success ){
                $('#loadingCog').hide();
                const toast = swal.mixin({
                  toast: true,
                  position: 'top',
                  showConfirmButton: false,
                  timer: 2000
                });

                toast({
                  type: 'error',
                  title:response.data.error
                })
              }
            }).catch(error=>{
              throw error;
            });
          },
          deleteSlug: function(){
            //delete it button clicked
            var self = this;
            $('#loadingCog').hide();
            axios.delete('/api/metadata/'+self.apis[self.selectedAPIIndex]._id+"?slug="+self.apis[self.selectedAPIIndex]._meta.slug).then(response=>{
              if( response.data.success ){
                self.apis[self.selectedAPIIndex]._meta.slug= '';
                const toast = swal.mixin({
                  toast: true,
                  position: 'top',
                  showConfirmButton: false,
                  timer: 2000
                });

                toast({
                  type: 'success',
                  title:'Slug was deleted'
                })
                self.createOrEditMode = false;
                self.hasShortName = false;
                $('#loadingCog').show();
              }else if( !response.data.success ){
                $('#loadingCog').hide();
                const toast = swal.mixin({
                  toast: true,
                  position: 'top',
                  showConfirmButton: false,
                  timer: 2000
                });

                toast({
                  type: 'error',
                  title:'Slug could not be set'
                })
              }
            }).catch(error=>{
              throw error;
            });
          },
          getUserInfo: function(){
            var self= this;
            axios.get('/user').then(response=>{
              self.userInfo = response.data;
              self.getApis();

            }).catch(err=>{
              throw err;
            })
          },
          getAnalytics(){
            var self = this;
            axios.get('	https://gasuperproxy-1470690417190.appspot.com/query?id=ahxzfmdhc3VwZXJwcm94eS0xNDcwNjkwNDE3MTkwchULEghBcGlRdWVyeRiAgIDMgsmRCgw').then(res=>{
              if (res.data.rows) {
                var payload = {};
                payload["analytics"] = res.data.rows;
                store.commit('saveAnalytics',payload);
              }
               // self.popularTags = _.orderBy(store.getters.getTags, ['name'],['desc'])

            }).catch(err=>{
              throw err;
            });
          }
        },
        mounted: function(){
           // JQuery Initializations
           this.showLoading();
           this.getAnalytics();
           this.getUserInfo();
           // tabs
           $('ul.tabs').tabs();

           // modals
           $('.modal').modal({dismissible: true});
           // notifications
           $('.tooltipped').tooltip({delay: 50});

           $('.collapsible').collapsible();

           tippy( '#tippyParent', {
            target: '.specVersion',
            content: `<div class="white" style="padding:0px;">
                        <table>
                          <tbody>
                            <tr>
                              <td class='green-text center'>
                                <b>OAS3</b>
                              </td>
                              <td class="blue-grey-text">
                                The OpenAPI Specification (OAS) (new version) defines a standard, language-agnostic interface to RESTful APIs which allows both humans and computers to discover and understand the capabilities of the service without access to source code, documentation, or through network traffic inspection. <a href="https://swagger.io/specification/" target="_blank">Learn more</a>
                              </td>
                            </tr>
                            <tr>
                              <td class='blue-text center'>
                                <b>Swagger2</b>
                              </td>
                              <td class="blue-grey-text">
                                Swagger (older version) allows you to describe the structure of your APIs so that machines can read them. <a href="https://swagger.io/specification/" target="_blank">Learn more</a>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>`,
            placement: 'left',
            theme:'light',
            trigger:'click',
            sticky:true,
            interactive:true,
          });


          tippy( '#dashApp', {
            target:'.popularity',
            content: 'Loading...',
            animateFill: false,
            animation: 'fade',
            theme:'light',
            trigger:'click',
            onShow(instance) {
              let name = instance.reference.dataset.tippyName;
              instance.setContent('<h6 class="blue-text">'+name+'</h6><canvas id="myChart" width="400" height="400"></canvas><div><small>Views = Viewed API details, Documentation = Viewed API documentation, Searched = Searched API by name</small></div>')
            },
            onShown(instance){
              let name = instance.reference.dataset.tippyName;
              let data = store.getters.getHitsFor(name);
              var ctx = document.getElementById('myChart');

              new Chart(ctx, {
                  'type': 'bar',
                  'data': data,
                  'options': {
                    'legend': { display: false },
                    'title': {
                      display: true,
                      text: 'User Interactions (Last 30 days)'
                    },
                    'scales': {
                      yAxes: [{
                          ticks: {
                              precision:0
                          }
                      }],
                  },
                  }
              });
            }
          });

          tippy( '#top-2', {
        target: '.urlStatus',
        content: `<div class="white" style="padding:0px;">
                    <table>
                      <thead>
                        <tr>
                          <td colspan="2" class='grey-text center'>
                            <b>Source URL & Metadata Status</b>
                          </td>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td class='green-text center'>
                            <b>OK</b>
                          </td>
                          <td class="black-text">
                            <small>Source URL is working and returns valid metadata.</small>
                          </td>
                        </tr>
                        <tr>
                          <td class='orange-text center'>
                            <b>NOT FOUND</b>
                          </td>
                          <td class="black-text">
                            <small>Source URL returns not found.</small>
                          </td>
                        </tr>
                        <tr>
                          <td class='red-text center'>
                            <b>INVALID</b>
                          </td>
                          <td class="black-text">
                            <small>Source URL works but contains invalid metadata.</small>
                          </td>
                        </tr>
                        <tr>
                          <td class='purple-text center'>
                            <b>BROKEN</b>
                          </td>
                          <td class="black-text">
                            <small>Source URL is broken.</small>
                          </td>
                        </tr>
                        <tr class="cyan lighten-5">
                          <td colspan='2' class='blue-grey-text'>
                            <p>
                              <b>Note: </b> API metadata cannot be synchronized with its source URL if the status is not <b class='green-text'>OK</b>. 
                            </p>
                            <p>
                              <b>Need help?</b> Click on the <b class='indigo-text'>Validate Only</b> button to see issues then the <b class='green-text'>Refresh</b> button once all issues have been resolved.
                            </p>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>`,
        placement: 'left',
        theme:'light',
        trigger:'click',
        sticky:true,
        interactive:true,
      });

          tippy( '#top', {
        target: '.apiStatus',
        content: `<div class="white" style="padding:0px;">
                    <table>
                      <thead>
                        <tr>
                          <td colspan="2" class='grey-text center'>
                            <b>Overall API Endpoint Status</b>
                          </td>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td class='green-text center'>
                            <b>PASS</b>
                          </td>
                          <td class="black-text">
                            <small>Your OpenAPI V3 API endpoints provide examples and all return code 200.</small>
                          </td>
                        </tr>
                        <tr>
                          <td class='red-text center'>
                            <b>FAIL</b>
                          </td>
                          <td class="black-text">
                            <small>Your OpenAPI V3 API endpoints provide examples but return code other than 200.</small>
                          </td>
                        </tr>
                        <tr> 
                          <td class='orange-text center'>
                            <b>UNKNOWN</b>
                          </td>
                          <td class="black-text">
                            <small>None of your OpenAPI V3 API endpoints provide examples and cannot be tested. <a href='/faq#api-monitor' target="_blank">Learn more about how to to enable API status check </a>.</small>
                          </td>
                        </tr>
                        <tr>
                          <td class='blue-text center'>
                            <b>INCOMPATIBLE</b>
                          </td>
                          <td class="black-text">
                            <small>Your API's specification does not match OpenAPI V3 specification and will not be tested. Use our guide to learn how to upgrade your metadata to OpenAPI V3 <a href="/guide" target="_blank">here</a>.</small>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>`,
        placement: 'left',
        theme:'light',
        trigger:'click',
        sticky:true,
        interactive:true,
      });


        },
        watch: {
          // whenever input changes
          inputApiName: function (input,old) {
            if(input.trim() === this.confirmModal.title){
              this.confirmDelete = false;
            }
            else{
              this.confirmDelete = true;
              //Materialize.toast(this.inputApiName+' Does Not Match API Name', 4000,'rounded orange white-text');
            }
          },
          searchQuery: function(query,old){
            if(!query){
              this.searchResults = [];
            }else{
              let result = this.apis.filter(o => o.info.title.toLowerCase().includes(query.toLowerCase()));
              this.searchResults = result;
            }
          },
          sortASC: function(sort,old){
            var self = this;
            if (!sort) {
              self.apis = _.sortBy(self.apis,'info.title');
              $("#sortName").text('A-Z');
            }else if (sort){
              self.apis = _.sortBy(self.apis,'info.title').reverse();
              $("#sortName").text('Z-A');
            }
          },
          myShortName: function(shortname,old){
            var self = this;
            self.myShortName = self.myShortName.toLowerCase();
            var re = /[^a-zA-Z0-9\-\_\~]/;
            self.invalidChars = false;
            if (re.test(self.myShortName) ) {
              self.invalidChars = true;
            }
            if( !re.test(self.myShortName) && shortname.length > 3 && shortname.length <= 50 ) {
                self.takenSlug = false;
                self.evaluateShortname();
            }else if(re.test(self.myShortName) && shortname.length > 3 && shortname.length <= 50){
              self.invalidChars = true;
              self.availableShortName = false;
            }else{
              self.availableShortName = false;
            }
          }
        }
    });
</script>
{% endblock %}
