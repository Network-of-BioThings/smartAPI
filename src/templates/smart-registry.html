{% extends "main.html" %}
{% include "smartapi-head.html" %}
{% block extra_head %}
{% endblock %}
{% block content %}
{% include "header.html" %}
{% raw %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<main class="white">
  <div id="app" style="height: 100%;" class="white container-fluid" v-cloak>
    <!-- Loading Screen -->
    <div v-show="loading" class="center-align loader">
      <div class="center-align">
        <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
      </div>
    </div>
      <div class="row full-height">
        <div class="col l2 s12 hide-on-med-and-down hide-on-small-only sidebar">
            <h5 class="blue-text center"> Filters</h5>
            <ul class="collapsible">
              <li>
                <div class="collapsible-header blue-grey white-text">
                  <small>Tags ({{tags.length}})</small>
                </div>
                <div class="collapsible-body noPadding">
                  <div class="collection">
                      <!-- Search Box -->
                      <div class="input-field collection-item">
                        <input v-model="tagsearch" placeholder="Search" id="fs" type="text">
                        <button @click.prevent="listAll = !listAll" class="smallButton grey copyBtn" >
                          <small v-if="!listAll">Show All ({{tags.length - listCap}} more)</small>
                          <small v-if="listAll">Show Less (Only 20)</small>
                        </button>
                      </div>
                      <!-- If searching - Results -->
                      <template v-for="tag in tagSearchResults" >
                        <a  v-if="tagsearch.length" class="collection-item"
                            style="padding:2px;"
                            :class="{ disable: tag.name.toLowerCase() === specialTagOriginalName.toLowerCase(), active: tag.active, blue: tag.active  && tag.name.toLowerCase() !== specialTagOriginalName.toLowerCase(), green: tag.active  && tag.name.toLowerCase() === specialTagOriginalName.toLowerCase() , 'white-text': tag.active}"
                            href="#!"
                            @click.prevent="toggleTag(tag,'tag');search(); googleAnalytics('Registry_Tag', tag.name)">
                          <small>{{tag.name}}  <span class="bold">({{tag.count}})</span></small>
                        </a>
                      </template>
                      <!-- no search - ALL -->
                      <template v-if="!tagsearch.length" v-for="(tag,index) in tags">
                        <a  v-if="index < listCap"
                            class="collection-item"
                            style="padding:2px;"
                            :class="{ disable: tag.name.toLowerCase() === specialTagOriginalName.toLowerCase(), active: tag.active, blue: tag.active  && tag.name.toLowerCase() !== specialTagOriginalName.toLowerCase(), green: tag.active  && tag.name.toLowerCase() === specialTagOriginalName.toLowerCase() , 'white-text': tag.active}"
                            href="#!"
                            @click.prevent="toggleTag(tag,'tag');search(); googleAnalytics('Registry_Tag', tag.name)">
                          <small>{{tag.name}}  <span class="bold">({{tag.count}})</span></small>
                        </a>
                      </template>

                  </div>
                </div>
              </li>

              <li>
                <div class="collapsible-header blue-grey white-text">
                  <small>Owners ({{authors.length}})</small>
                </div>
                <div class="collapsible-body noPadding">
                  <div class="collection">
                      <!-- Search Box -->
                      <div class="input-field collection-item">
                        <input v-model="ownersearch" placeholder="Search" id="os" type="text">
                        <button @click.prevent="listAll = !listAll" class="smallButton grey copyBtn" >
                          <small v-if="!listAll">Show All ({{authors.length - listCap}} more)</small>
                          <small v-if="listAll">Show Less (Only 20)</small>
                        </button>
                      </div>
                      <!-- If searching - Results -->
                      <template v-if="ownersearch.length" v-for="tag in ownerSearchResults" >
                        <a  class="collection-item"
                            style="padding:2px;"
                            :class="{ disable: tag.name.toLowerCase() === specialTagOriginalName.toLowerCase(), active: tag.active, blue: tag.active  && tag.name.toLowerCase() !== specialTagOriginalName.toLowerCase(), green: tag.active  && tag.name.toLowerCase() === specialTagOriginalName.toLowerCase() , 'white-text': tag.active}"
                            href="#!"
                            @click.prevent="toggleTag(tag,'author');search(); googleAnalytics('Registry_Tag', tag.name)">
                          <small>{{tag.name}}  <span class="bold">({{tag.count}})</span></small>
                        </a>
                      </template>
                      <!-- no search - ALL -->
                      <template v-if="!ownersearch.length" v-for="(tag,index) in authors">
                        <a  v-if="index < listCap"
                            class="collection-item"
                            style="padding:2px;"
                            :class="{ disable: tag.name.toLowerCase() === specialTagOriginalName.toLowerCase(), active: tag.active, blue: tag.active  && tag.name.toLowerCase() !== specialTagOriginalName.toLowerCase(), green: tag.active  && tag.name.toLowerCase() === specialTagOriginalName.toLowerCase() , 'white-text': tag.active}"
                            href="#!"
                            @click.prevent="toggleTag(tag,'author');search(); googleAnalytics('Registry_Tag', tag.name)">
                          <small>{{tag.name}}  <span class="bold">({{tag.count}})</span></small>
                        </a>
                      </template>

                  </div>
                </div>
              </li>
            </ul>

            <ul class="collection" style="margin-top:100px;" v-show="popularTags && popularTags.length > 5">
              <div class="collection-header orange-text center">
                <small>Filters Most Active <br />(Last 30 days)</small>
              </div>
              <template v-for="(pop,index) in popularTags">
                  <a v-if="index < 10" :href="pop.type == 'tags'?'/registry?tags='+pop.name:'/registry?owners='+pop.name" :class="{ active: pop.active, blue: pop.active, bold:index==0 }" :title="pop.count" @click="googleAnalytics('Registry_Tag', pop.name)" class="collection-item" style="padding:4px;" >
                  {{index+1}} <small><span v-text="pop.type == 'tags' ? '#' : '@'"></span> <span v-text="pop.name"></span></small>
                </a>
              </template>
            </ul>
        </div>
          <div class="col s12 hide-on-med-and-up show-on-small-only">
              <ul class="collapsible">
                <li>
                  <div class="collapsible-header blue-grey white-text">
                    <small>Filter by Tags</small>
                  </div>
                  <div class="collapsible-body noPadding">
                    <div class="collection">
                      <div class="colllection-item padding20">
                        <template v-for="tag in tags">
                          <a class="chip" :class="{ disable: tag.name.toLowerCase() === specialTagOriginalName.toLowerCase(), active: tag.active, blue: tag.active  && tag.name.toLowerCase() !== specialTagOriginalName.toLowerCase(), green: tag.active  && tag.name.toLowerCase() === specialTagOriginalName.toLowerCase() , 'white-text': tag.active}" href="#!"  @click.prevent="tag.active = !tag.active;search(); googleAnalytics('Registry_Tag', tag.name)">{{tag.name}}  <span class="bold">({{tag.count}})</span></a>
                        </template>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="collapsible-header blue-grey white-text center-align">
                    <small>Filter by Owners</small>
                  </div>
                  <div class="collapsible-body noPadding">
                    <div class="collection">
                      <div class="colllection-item padding20">
                        <template v-for="author in authors" >
                          <a :class="{ active: author.active, blue: author.active }" href="#!" class="chip" @click.prevent="author.active = !author.active;search(); googleAnalytics('Registry_Author', author.name)">{{author.name}}  <span class="bold">({{author.count}})</span> <span class="red-text" v-if="userInfo && author.name === userInfo.name">(Me)</span></a>
                        </template>
                      </div>
                    </div>
                  </div>
                </li>
              </ul>
          </div>
          <form class="col s12 l10 center-align" @submit.prevent="search()" id="api_search_form">
            <template v-if='specialTagsUI'>
              <div  class="col s12 l3 input-field center-align">
                <a class='tooltipped p-1' data-position="bottom" :data-tooltip="'Learn More about '+specialTagName" :href="specialTagURL" target="_blank" style="cursor: pointer !important;">
                  <img v-if="specialTagsUI" height="70px" width="auto" :src="specialTagImage"  :alt="specialTagName"/>
                </a>
                <div v-if="specialTagName == 'NCATS Biomedical Data Translator'">
                  <a class="purple-text d-block" href="/portal/translator/">
                    Go to portal <i class="fa fa-chevron-right" aria-hidden="true"></i>
                  </a>
                </div>
              </div>
              <div class="input-field col s12 l6">
                  <input aria-required="false" required='false' id="search_query" type="text" v-model="query" name="query" placeholder="Enter any query term here" class="browser-default margin20 grey lighten-5 blue-grey-text lighter" style="width: 80%; outline: none; padding: 10px; border-radius: 20px; border:var(--blue-medium) 2px solid;">
              </div>
            </template>
            <template v-else>
              <div class="input-field col s12 l6 offset-l3">
                  <input aria-required="false" required='false' id="search_query" type="text" v-model="query" name="query" placeholder="Enter any query term here" class="browser-default margin20 grey lighten-5 blue-grey-text lighter" style="width: 80%; outline: none; padding: 10px; border-radius: 20px; border:var(--blue-medium) 2px solid;">
              </div>
            </template>

              <div class="col s12 selected-tags">
                  <div class="chip" v-for="tag in tags" v-if="tag.active" :class="{ green: tag.name.toLowerCase() === specialTagOriginalName.toLowerCase(), 'white-text': tag.name.toLowerCase() === specialTagOriginalName.toLowerCase() }">
                    {{tag.name}}
                      <i v-if="tag.name.toLowerCase() !== specialTagOriginalName.toLowerCase()" class="close material-icons" @click="toggleTag(tag,'tag');search()">close</i>
                  </div>
                  <div class="chip" v-for="author in authors" v-if="author.active">
                      {{author.name}}
                      <i class="close material-icons" @click="toggleTag(author,'author');search()">close</i>
                  </div>
                  <div class="chip" v-for="pop in popularTags" v-if="pop.active">
                      {{pop.name}}
                      <i class="close material-icons" @click="pop.active = false;search()">close</i>
                  </div>
              </div>
              <div class="col s12">
                  <button type="submit" @click="googleAnalytics('Registry_Searches',query)" class="waves-effect waves-light blue btn">search</button>&nbsp;&nbsp;&nbsp;
                  <a class="blue btn" href="/registry">clear</a>
              </div>
          </form>
          <div class="col s12 l10" id="myAPITipCont">
              <div class="row search-results" id="tippyParentCopy">
                  <div class="col s12" id="tippyParent">
                      <div class="blue-grey-text">
                          <div class="row">
                            <div class="col s5 m10">
                              <template v-if="total && total > 0">
                                <span class="blue-text" v-text="'Total APIs: '+total"></span>
                                <button :data-clipboard-text='shareURL' @click.prevent="googleAnalytics('Registry_SharedURL', window.location.search );" v-if="shareURLButtonVisible" class="smallButton grey copyBtn" title='Copy to clipboard'>
                                  <i class="fa fa-clipboard" aria-hidden="true"></i> Copy Search URL
                                </button>
                              </template>
                            </div>
                            <div class="col s5 m2">
                              <select class="browser-default" v-model="sort" @change='search()'>
                                <option value="" disabled>Sort By</option>
                                <option value="Relevance" selected>Relevance</option>
                                <option value="Alphabetically A-Z">Alphabetically A-Z</option>
                                <option value="Alphabetically Z-A">Alphabetically Z-A</option>
                                <option value="Recently Updated">Recently Updated</option>
                              </select>
                            </div>
                          </div>
                      </div>
                      <template v-if="total == 0">
                        <div class="card">
                          <div class="card-content center">
                            <i class="fa fa-exclamation-circle fa-2x grey-text" aria-hidden="true"></i>
                            <h5 class="grey-text">Your Search Returned No Results</h5>
                          </div>
                        </div>
                      </template>
                      <template v-for="api in apis">
                        <api-container :api="api" :total="total" :user="userInfo" :key="api._id"></api-container>
                      </template>
                      <div class="row">
                          <div class="col s12 m10 l10">
                            <div class="row">
                              <div class="col s2">
                                <ul class="pagination">
                                  <li :class="{ disabled: page <= 1 }">
                                      <a href="#" @click.prevent="prevPage(); search()"><i class="material-icons">chevron_left</i> Previous</a>
                                  </li>
                              </ul>
                              </div>
                              <div class="col s8">
                                <ul class="pagination">
                                  <li :class="{ active: page == n, blue: page == n, 'white-text': page == n  }" v-for="n in pages">
                                      <a href="#" @click.prevent="page = n; search()">{{n}}</a>
                                  </li>
                              </ul>
                              </div>
                              <div class="col s2">
                                <ul class="pagination">
                                  <li :class="{ disabled: page >= pages }">
                                      <a href="#" @click.prevent="nextPage(); search()">Next <i class="material-icons">chevron_right</i></a>
                                  </li>
                              </ul>
                              </div>
                            </div>
                              
                          </div>
                          <div class="col s12 m2 l2 right-align">
                              Per page:
                              <select class="perPage" v-model="perPage" @change="calculatePages; search()" id="perPage">
                                  <option value="10">10</option>
                                  <option value="20">20</option>
                                  <option value="50">50</option>
                                  <option value="100">100</option>
                              </select>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>
</main>
{% endraw %}
{% include "footer.html" %}
{% endblock %}
{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.6/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js"></script>
<script src="/static/js/clipboard.js"></script>
<script src="/static/js/moment.js"></script>
<script src="https://unpkg.com/tippy.js@3/dist/tippy.all.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-139873613-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-139873613-1', {
    'custom_map': {
      'dimension5':'registryResults',
      'metric1':'registry-item'
    }
  });

  new ClipboardJS('.copyBtn');
      ClipboardJS.isSupported();

  Vue.component('description', {
    data: function(){
      return{
        result:null,
        fullTXT:false
      }
    },
    props: ['text'],
    methods:{
      compileMDWN: function(mdtext){
        this.result = marked(mdtext, { sanitize: true });
        return this.result;
      }
    },

    mounted: function(){
      this.compileMDWN(this.text)
    },
    template: `<div>
                <div class="expandContainer" v-bind:class="{'max-height-none' : fullTXT, 'max-height-200': !fullTXT}">

                  <div class="center">

                    <a class="btn grey lighten-1 expandButtonLess" v-if="fullTXT" @click.prevent="fullTXT = !fullTXT;">
                      Collapse
                    </a>
                  </div>

                  <div class="blue-grey-text" v-html="result"></div>

                  <div class="center">
                    <a class="btn grey lighten-1 expandButtonLess" v-if="fullTXT" @click.prevent="fullTXT = !fullTXT;">
                      Collapse
                    </a>
                  </div>

                  <div v-if="!fullTXT" class="whiteFadeBox center">
                    <a class="btn grey lighten-1 expandButtonMore" v-if="!fullTXT" @click.prevent="fullTXT = !fullTXT;">Click to expand</a>
                  </div>
                </div>
              </div>`
  });

  Vue.component('source-status', {
  data: function(){
    return{
      status:'',
      clss:'',
    }
  },
  props: ['api'],
  methods:{
    getStatus(api){
      let self = this;
      if (api?._status?.refresh_status) {
        let stat = api['_status']['refresh_status'];
        switch (stat) {
          case 200:
            self.status = "OK";
            self.clss = 'green';
            break;
          case 299:
            self.status = "OK";
            self.clss = 'green';
            break;
          case 499:
            self.status = "INVALID";
            self.clss = 'red';
            break;
          case 599:
            self.status = "BROKEN";
            self.clss = 'purple';
            break;
          case 404:
            self.status = "NOT FOUND";
            self.clss = 'orange';
            break;
          default:
            self.status = "BROKEN";
            self.clss = 'purple';
        }
      }else{
        self.status = 'N/A';
          self.clss = 'grey darken-1';
      }
    },
  },
  mounted: function(){
    this.getStatus(this.api);
  },
  template: `<div v-if="api && api['_status']" class="urlStatus" title="Click to learn more">
              <div class="blue-grey-text">Source</div>
              <div v-text="status" :class='clss'></div>
            </div>`
});

  Vue.component('api-container', {
    data: function(){
      return{
        showDetails:false,
        overLimit: false,
        pathTotal: 0,
        bt_tag: Object
      }
    },
    props: ['api', 'total', 'user'],
    methods:{
      compiledMarkdown: function (mdtext) {
          return marked(mdtext, { sanitize: true })
      },
      getDate(timestamp){
        var date = moment(timestamp).format("LL");
        return date;
      },
      googleAnalytics(category, label){
        // console.log('category',category,label)
        // gtag('event','click',{'event_category':'general','event_label':label,'event_value':1})

        switch (category) {
          case 'Registry_Tag':
            gtag('event','click',{'event_category':'tag','event_label':label,'event_value':1})
            break;
          case 'Registry_Author':
            gtag('event','click',{'event_category':'author','event_label':label,'event_value':1})
            break;
          case 'Registry_APIs':
            gtag('event','click',{'event_category':'expanded','event_label':label,'event_value':1})
            break;
          case 'Registry_SharedURL':
            gtag('event','click',{'event_category':'shared','event_label':label,'event_value':1})
            break;
          case 'Registry_Searches':
            gtag('event','click',{'event_category':'searched','event_label':label,'event_value':1})
            break;
          case 'Registry_Documentation':
            gtag('event','click',{'event_category':'documentation','event_label':label,'event_value':1})
            break;
          default:
          gtag('event','click',{'event_category':'general','event_label':label,'event_value':1})
        }
      },
      operationStyling: function(op){
        //styles operations based on type
        switch( op.substr(0,3) ){
              case 'GET' :
                return 'bold light-blue darken-1 white-text operation';
                break;
              case 'POS' :
                return 'bold light-green white-text operation';
                break;
              case 'PUT' :
                return 'bold amber lighten-2 white-text operation';
                break;
              case 'DEL' :
                  return 'bold deep-orange darken-1 white-text operation';
                  break;
              case 'HEA' :
                  return 'bold deep-purple lighten-1 white-text operation';
                  break;
              case 'PAT' :
                  return 'bold brown lighten-1 white-text operation';
                  break;
              case 'PAR' :
                  return 'bold teal lighten-1 white-text operation';
                  break;
              default:
                 return 'bold gray lighten-1 white-text operation'
                  break;
        }
      },
      buildEditURL: function (raw_url) {
        // build edit github url from raw.githubusercontent type source:
        if(raw_url.includes("raw.githubusercontent")){
          var new_url = raw_url.replace("/raw.githubusercontent.com/","").split("/")
          new_url.splice(3, 0, "edit")
          new_url.splice(1, 0, "/github.com");
          new_url = new_url.join("/")
          return new_url
        }
        // build edit github url from github type source:
        else{
          return raw_url.replace("/raw/","/edit/")
        }
      },
      getOperations: function (api, raw=false) {
        var self= this;
          var operations = [];
          if (raw) {
              for(var path in api.paths) {
                  for(var method in api.paths[path]) {
                      operations.push({'method': self.validateFields(method.toUpperCase()), 'summary': path['pathitem'][method].summary, 'path': path })
                  }
              }
          }else{
              for (endpoint in api.paths) {
                const item = api.paths[endpoint];
                for(var method in item) {
                  if (Object.prototype.hasOwnProperty.call(item[method], "summary")) {
                    operations.push({'method': self.validateFields(method.toUpperCase()), 'summary': item[method]['summary'], 'path': endpoint })
                  }else if (Object.prototype.hasOwnProperty.call(item[method], "description")) {
                    operations.push({'method': self.validateFields(method.toUpperCase()), 'summary': item[method]['description'], 'path': endpoint })
                  }
                }
              }
          }
          self.pathTotal = operations.length
          if (self.pathTotal > 20 ) {
            operations = operations.slice(0,19);
            self.overLimit = true
          }
          return operations;
      },
      validateFields(path){
        let paths = ['GET','POST','PUT','DELETE','PATCH','TRACE','HEAD','CONNECT'];
        if (paths.includes(path)) {
          return path;
        }else if (path === "PARAMETERS") {
            return 'GET';
        }
      },
    },
    mounted: function(){
      if(Object.prototype.hasOwnProperty.call(this.api, "tags")){
        this.bt_tag = this.api?.['tags'].find(element => element.name == 'biothings');
      }
    },
    template: `
    <div class="card context">
    <div class="card-content ">
          <span class="card-title">
            <span class="blue-grey-text bold" v-text="api.info.title"></span>
            <span class="versionBadge grey" v-text="'V.'+api.info.version">
            </span>
            <span v-if=" api?.openapi " class="versionBadge green">
              OAS3
            </span>
            <span v-else-if=" api?.swagger " class="versionBadge blue">
              Swagger2
            </span>
            <span v-if="api?.info?.['x-trapi']?.version" class="versionBadge pink lighten-2" v-text="'TRAPI '+api?.info?.['x-trapi']?.version">
            </span>
            <span v-if="bt_tag && bt_tag.name == 'biothings' " class="versionBadge grey darken-2">
              BioThings API
            </span>
            <a v-if="user && api._meta.username === user.login" 
              :data-tippy-status="api?._status?.refresh_status || 'n/a' "
                href="/dashboard" class="versionBadge light-blue pointer tipped">
              My&nbsp;API 
              <span v-if="api?._status?.refresh_status && ![200, 299, '200', '299'].includes(api?._status?.refresh_status)" 
              class="white-text red" style="padding:2px;border-radius: 4px;margin-left: 5px;">&nbsp;&nbsp;!&nbsp;&nbsp;</span>
            </a>

            <div v-if="api && api['_status']" class="apiStatus" title="Click to learn more">
              <div class="blue-grey-text">Uptime</div>
              <template v-if="api['_status'] && api['_status']['uptime_status'] ==='bad'">
                <div class="red">
                  FAIL
                </div>
              </template>
              <template v-else-if="api['_status'] && api['_status']['uptime_status'] ==='good'">
              <div class="green">
                PASS
              </div>
              </template>
              <template v-else-if="api['_status'] && api['_status']['uptime_status'] ==='unknown'">
              <div class="orange">
                UNKNOWN
              </div>
              </template>
              <template v-else-if="api['_status'] && api['_status']['uptime_status'] ==='incompatible'">
              <div class="blue">
                INCOMPATIBLE
              </div>
              </template>
              <template v-else>
              <div class="gray-text grey">
                N/A
              </div>
              </template>
            </div>


          </span>
          <template v-if="api.info.description && api.info.description.length > 500">
            <description :text='api.info.description'></description>
          </template>
          <template v-else>
            <div class="blue-grey-text" v-html="compiledMarkdown(api.info.description || '')"></div>
          </template>
          <hr style="border: dotted 1px #e8e8e8 !important;"/>
          <div class="full-width grey-text">
            <template v-for="(tag,index) in api.tags" :key="tag.name">
              <a :href="'?tags='+tag.name" @click="googleAnalytics('Registry_Tag', tag.name)" class="link">
                <small>#<span v-text="tag.name"></span></small>
              </a>
              <span v-if="index !== api.tags.length-1">, </span>
            </template>
          </div>
      </div>
      <!-- TOGGLE DETAILS -->
      <div class="card-action grey lighten-3" v-if="total > 1" :class="showDetails?'blue':'grey'">
          <a style="border-radius: 20px;" class="btn" :class="showDetails?'grey lighten-3 blue-text':'blue white-text'" href="#" @click.prevent="showDetails = !showDetails; googleAnalytics('Registry_APIs',api.info.title)" v-text="showDetails?'HIDE DETAILS':'SHOW DETAILS'"></a>
      </div>
      <div class="card-content detailsBack" v-if="showDetails || total === 1">
        <div class="row">
          <div class="col s12 right-align">
            <small class="grey-text">Updated: </small><small class="white-text"><span v-text="getDate(api._meta.timestamp)"></span> </span></small>
          </div>
          <div class="col s12 left">
            <h4 class="white-text bold m" style="display:inline-block;" v-text="api.info.title"></h4>
            <h5 class="grey-text" style="display:inline-block;">V <span v-text="api.info.version"></span></h5>
          </div>
          <div class="col s12">
            <table class="apiDetails responsive-table">
              <colgroup>
                <col span="1" style="width:25%">
                <col span="1" style="width:75%">
              </colgroup>
              <tbody>
                <tr>
                  <td>
                    <small class="white-text">Created By</small>
                  </td>
                  <td>
                    <small class="white-text">
                      <i class="fa fa-user" aria-hidden="true"></i> <span v-text="api?.info?.contact?.name || 'Name Unavailable'"></span>
                    </small>
                  </td>
                </tr>
                <tr>
                  <td>
                    <small class="white-text">Registered by</small>
                  </td>
                  <td>
                    <small class="white-text">
                      <a :href="'https://github.com/'+api._meta.username" target="_blank" rel="nonreferrer"><i class="fa fa-user" aria-hidden="true"></i> <span v-text="api._meta.username"></span></a>
                    </small>
                  </td>
                </tr>
                <tr>
                  <td>
                    <small class="white-text">SmartAPI ID</small>
                  </td>
                  <td>
                    <a class="link" target="_blank" v-bind:href='"/api/metadata/"+api._id'>
                      <small>
                        <span :id="'id'+api._id" :value="api._id" v-text="api._id"></span> <i class="fa fa-external-link" aria-hidden="true"></i>
                      </small>
                    </a>
                    <button class="smallButton grey copyBtn" :data-clipboard-text="api._id">
                        <i class="fa fa-clipboard" aria-hidden="true"></i>
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <small class="white-text">Source URL</small>
                  </td>
                  <td>
                    <a class="link" target="_blank" v-bind:href='api._meta.url'>
                      <small><span v-text="_.truncate(api._meta.url)"></span> <i class="fa fa-external-link" aria-hidden="true"></i></small>
                    </a>
                    <button class="smallButton grey copyBtn" :data-clipboard-text="api._meta.url">
                        <i class="fa fa-clipboard" aria-hidden="true"></i>
                    </button>
                    <a class="smallButton grey" title="Edit metadata source on GitHub" v-if="user && api._meta.username === user.login && api._meta.url.includes('github')" v-bind:href="buildEditURL(api._meta.url)" 
                      target="_blank">
                        <i class="fa fa-pencil" aria-hidden="true"></i>
                    </a>
                    <source-status :api='api'></source-status>
                  </td>
                </tr>
                <tr>
                  <td>
                    <small class="white-text">SmartAPI Registry URL</small>
                  </td>
                  <td>
                    <a class="link" target="_blank" v-bind:href='"?q="+api._id'>
                      <small><span :id="'url'+api._id" :value="api._id">http://smart-api.info/registry?q=<span v-text="api._id"></span> </span></small>
                    </a>
                    <button class="smallButton grey copyBtn" :data-clipboard-text="'http://smart-api.info/registry?q='+api._id">
                        <i class="fa fa-clipboard" aria-hidden="true"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="col s12" style="padding:20px;">
            <a class="btn green" style="margin:5px;"
               v-bind:href='"/ui/"+api._id' @click="googleAnalytics('Registry_Documentation', api.info.title)">
               <span class="hide-on-small-only">View API</span> Documentation
            </a>
            <a class="btn blue" style="margin:5px;"
               v-bind:href='"/editor/"+api._id'>
               Edit <i class="fa fa-pencil" aria-hidden="true"></i>
            </a>
          </div>
        </div>
        <div>
          <template v-if="api?.openapi">
            <h5 class="grey-text">(<span v-text="pathTotal"></span>) Operations</h5>
            <h6 v-if="overLimit">
              <small class="grey-text">This is just a preview. For a full list click on <b class="green-text">View API Documentation</b> link above.</small> 
            </h6>
            <table class="striped responsive-table white" style="margin: 20px 0px;">
              <col width="10%">
              <col width="30%">
              <col width="60%">
              <tbody>
                <tr v-for="operation in getOperations(api)" :key="operation.path">
                  <td class="center-align" :class="operationStyling(operation.method)" v-text="operation.method">
                  </td>
                  <td class="blue-text bold" v-text="operation.path">
                  </td>
                  <td class="blue-grey-text" v-text="operation.summary">
                  </td>
                </tr>
              </tbody>
            </table>
          </template>
        </div>
      </div>
    </div>
    `
  });

  var app = new Vue({
      el: '#app',
      data: function(){
        return {
            total: Number,
            query: '',
            page: 1,
            pages: 1,
            perPage: 10,
            specialTagsUI: false,
            specialTagName: '',
            specialTagImage: '',
            specialTagURL: '',
            specialTagOriginalName: '',
            shareURL:'',
            shareURLButtonVisible: false,
            sort: 'Relevance',
            loading: false,
            tagsearch:'',
            tagSearchResults:[],
            ownersearch:'',
            ownerSearchResults:[],
            listAll:false,
            listCap:20,
            ownersNotFound: [],
            tagsNotFound: [],
            userInfo: {},
            context: Object,
            popularTags: [],
            tags:Array,
            apis: [],
            tags: [],
            authors: [],
        }
      },
      methods: {
          googleAnalytics(category, label){
            // console.log('category',category,label)
            // gtag('event','click',{'event_category':'general','event_label':label,'event_value':1})
            switch (category) {
              case 'Registry_Tag':
                gtag('event','click',{'event_category':'tag','event_label':label,'event_value':1})
                break;
              case 'Registry_Author':
                gtag('event','click',{'event_category':'author','event_label':label,'event_value':1})
                break;
              case 'Registry_APIs':
                gtag('event','click',{'event_category':'expanded','event_label':label,'event_value':1})
                break;
              case 'Registry_SharedURL':
                gtag('event','click',{'event_category':'shared','event_label':label,'event_value':1})
                break;
              case 'Registry_Searches':
                gtag('event','click',{'event_category':'searched','event_label':label,'event_value':1})
                break;
              case 'Registry_Documentation':
                gtag('event','click',{'event_category':'documentation','event_label':label,'event_value':1})
                break;
              default:
              gtag('event','click',{'event_category':'general','event_label':label,'event_value':1})
            }
          },
          highlightQuery: function(){
            this.mark(this.query);
          },
          mark: function(kw){
            //unmark and mark current search
            var self= this;
            $(".context").unmark({
              done: function() {
                $(".context").mark(kw);
              }
            });
          },
          initialAPILoad: function(){
              var self = this;
              let url = "/api/query?"
              self.handleContext(self.context);
              //check for existing query in url string
              self.checkforQuery();
              let query = self.query;
              if(!self.query){
                query="__all__"
              }
              
              var config = {
                  "params": {
                      "q": encodeURIComponent(query),
                      'fields': 'info,_meta,_status,paths,tags,openapi,swagger',
                      'size': self.perPage,
                      'from': self.page == 1 ? self.page-1 : ((self.page-1) * self.perPage )  
                  }
              }
              var filters = self.getQueryFilters();
              if (Object.keys(filters).length !== 0){
                for (const param in filters) {
                  url += "&"+param+"="+encodeURIComponent(filters[param])
                }
              }
              self.loading = true;
              axios.get(url, config).then(function(response){
                  self.loading = false;

                  self.apis = response.data.hits;

                  self.total = response.data.total;
                  self.calculatePages();
              }).catch(err=>{
                self.loading = false;
                throw err;
              });
          },
          loadFilters: function (){
              var self = this;
              axios.get('/api/suggestion?field=tags.name').then(function(response){
                  let temp_data = []
                  for(key in response.data){
                    temp_data.push({key: key, doc_count: response.data[key]})
                  }
                  let tags = _.map(temp_data, function(item){
                      return {'name':item.key, 'count': item.doc_count, 'active': false};
                  });
                  self.tags = tags;

                  axios.get('/api/suggestion?field=info.contact.name').then(function(response){
                      let temp_data = []
                      for(key in response.data){
                        temp_data.push({key: key, doc_count: response.data[key]})
                      }
                      let authors = _.map(temp_data, function(item){
                          return {'name':item.key, 'count': item.doc_count, 'active': false};
                      });

                      self.authors = authors;
                      //When all filters all loaded
                      //share url params depend on filters being loaded
                      self.initialAPILoad();
                  });

              });
          },
          getQueryFilters: function(){
              var tagFilters = [];
              var authorFilters = [];
              var finalFilters = {};
              // regular tags
              this.tags.forEach(function(item){
                if (item.active){
                  tagFilters.push('"'+item.name+'"');
                }   
              });
              // include not found on list
              this.tagsNotFound.forEach(tag => {
                tagFilters.push('"'+tag+'"');
              })
              //popular tags
              this.popularTags.forEach(function(item){
              if (item.active && !tagFilters.includes(item.name))
                tagFilters.push('"'+item.name+'"');
              });

              if (tagFilters.length > 0){
                finalFilters['tags'] = tagFilters;
              }

              this.authors.forEach(function(item){
                if (item.active){
                  authorFilters.push('"'+item.name+'"');
                }
              });
              // include not found on list
              this.ownersNotFound.forEach(owner => {
                authorFilters.push('"'+owner+'"');
              })
              if (authorFilters.length){
                finalFilters['authors'] = authorFilters;
              }
              // console.log('filters found', finalFilters)
              return finalFilters;
          },
          searchForTags: function(tagName){
            var self = this;
            for (var i = 0; i < self.tags.length; i++) {
              if (self.tags[i].name === tagName) {
                self.tags[i].active = !self.tags[i].active;
                self.search();
              }
              else{
                self.search();
              }
            }
          },
          buildShareURL: function(q){
            var filters = [];
            var authorFilters = [];
            var finalFilters = '';
            var finalAuthorFilters ='';
            var finalURL = window.location.origin+window.location.pathname;
            // Collect TAGS
            this.tags.forEach(function(item){
              if (item.active)
                  filters.push(item.name);
              });
            // Collect Owners
            this.authors.forEach(function(item){
              if (item.active){
                authorFilters.push(item.name);
              }
            });
            //Detect QUERY
            if (q !== '__all__') {
              finalURL = finalURL+'?q='+q;
              //if any tags are actuve
              if(authorFilters.length || filters.length){
                finalURL = finalURL+"&";
              }
            }
            //if tags active but no query
            else if(authorFilters.length || filters.length){
              finalURL = finalURL+"?";
            }
            // if BOTH filters exists
            if (filters.length && authorFilters.length) {
              finalFilters = filters.join(',')
              finalURL = finalURL+"tags="+finalFilters;

              finalAuthorFilters = authorFilters.join(',')
              finalURL = finalURL+"&owners="+finalAuthorFilters;
            }
            // if Owners Exist but no Tags
            else if (!filters.length && authorFilters.length) {
              finalAuthorFilters = authorFilters.join(',')
              finalURL = finalURL+"owners="+finalAuthorFilters;
            }
            // if Tags exists but no owners
            else if (filters.length && !authorFilters.length) {
              finalFilters = filters.join(',')
              finalURL = finalURL+"tags="+finalFilters;
            }

            this.shareURL =finalURL;
            //HTML5 change url history
            window.history.pushState({"html":'content',"pageTitle":'SmartAPI'},"", finalURL);
            this.shareURLButtonVisible = true;
          },
          search: function () {
              var self = this;
              let url = '/api/query?'
              let query = self.query.trim();
              // reset results
              self.apis = [];
              self.total = 0;
              //unmark keywords
              $(".context").unmark();

              if (!self.context.Special && !query){
                query = "__all__";
              }
              else if (self.context.Special && !query) {
                query = query || "__all__";
                // self.handleSpecialTags(self.context.Tags[0]);
              }
              if (query) {

                  self.googleAnalytics('Registry_Searches',query)

                  var config = {
                      "params": {
                          "q": encodeURIComponent(query),
                          'fields': 'info,_meta,_status,paths,tags,openapi,swagger',
                          'size': self.perPage,
                          'from': self.page == 1 ? self.page-1 : ((self.page-1) * self.perPage )          
                      },
                  };
                  var filters = this.getQueryFilters();
                  if (Object.keys(filters).length !== 0){
                    for (const param in filters) {
                      url += "&"+param+"="+encodeURIComponent(filters[param])
                    }
                  }
                  self.loading = true;
                  // Share search URL
                  self.buildShareURL(query);

                  // sort
                  switch (self.sort) {
                    case 'Relevance':
                      //default behavior
                      break;
                    case 'Alphabetically A-Z':
                      url = url+'&sort=info.title.raw'
                      break;
                    case 'Alphabetically Z-A':
                      url = url+'&sort=-info.title.raw'
                      break;
                    case 'Recently Updated':
                      url = url+'&sort=_meta.last_updated'
                      break;
                    default:
                      //no matching sort
                      break;
                  }
                  axios.get(url, config).then(function (response) {
                      self.loading = false;
                      $(".context").unmark();
                      self.apis = response.data.hits;
                      // self.handleContext(self.context);
                      self.total = response.data.total;
                      self.calculatePages();
                  }).catch(err=>{
                    self.loading = false;
                    throw err;
                  });
              }
          },
          calculatePages: function () {
              this.pages = Math.ceil(this.total / this.perPage);
              // console.log("____________")
              // console.log('total', this.total)
              // console.log('per page', this.perPage)
              // console.log('pages', this.pages)
              if(this.page > this.pages){
                this.page = 1
              }
          },
          prevPage: function () {
              if (this.page > 1)
                  this.page -= 1
          },
          nextPage: function () {
              if (this.page < this.pages)
                  this.page += 1
          },
          getUserInfo: function(){
            var self= this;
            axios.get('/user').then(response=>{self.userInfo = response.data}).catch(err=>{throw err});
          },
          handleRegularTags: function(rTags){
            var self = this;
              self.specialUI = false;
              for (var i = 0; i < rTags.length; i++) {
                for (var x = 0; x < self.tags.length; x++) {
                  if (rTags[i].toLowerCase() === self.tags[x].name.toLowerCase()) {
                    self.toggleThisTag(self.tags[x])
                  }
                }
              }
          },
          handleOwnerTags: function(rTags){
            var self = this;
              self.specialUI = false;
              for (var i = 0; i < rTags.length; i++) {
                for (var x = 0; x < self.authors.length; x++) {
                  if (rTags[i].toLowerCase() === self.authors[x].name.toLowerCase()) {
                    self.toggleThisAuthor(self.authors[x])
                  }
                }
              }
          },
          handleContext: function(context){
            if (context.Special) {
              this.handleSpecialTags(this.context.Tags[0]);
            }
            if (!context.Special && !_.isEmpty(context.Tags)) {
              this.handleRegularTags(this.context.Tags);
            }
            if (!context.Special &&  !_.isEmpty(context.Owners)) {
              this.handleOwnerTags(this.context.Owners);
            }
          },
          handleSpecialTags: function(tagname){
            var self = this;
              self.specialTagsUI = true;
              self.specialTagOriginalName = tagname.toUpperCase();
              switch (tagname) {
                case 'translator':
                  self.specialTagName = 'NCATS Biomedical Data Translator';
                  self.specialTagImage = '/static/img/TranslatorLogo.JPG';
                  self.specialTagURL = 'https://ncats.nih.gov/translator';
                  break;
                  case 'nihdatacommons' || 'NIHdatacommons':
                    self.specialTagName = 'NIH Data Commons';
                    self.specialTagImage = '/static/img/nih-logo.png';
                    self.specialTagURL = 'https://commonfund.nih.gov/commons';
                    break;
                default:
                  self.specialTagName = tagname.toUpperCase();
                  self.specialTagImage = '/static/img/logo-small.png';
                  self.specialTagURL = 'https://smart-api.info';
              }
              for (var i = 0; i < self.tags.length; i++) {
                if (self.tags[i].name.toLowerCase() === tagname.toLowerCase()) {
                  Vue.set(self.tags[i], 'active', true)   
                 }
              }            
          },
          checkforQuery: function(){
            var self = this;
            var url_string = window.location.href
            var url = new URL(url_string);

            var q = url.searchParams.get("q");
            if (q) {
              this.query = q;
            }

            var tags = url.searchParams.get("tags");
            // console.log('TAGS FOUND',tags)
            if (tags) {
              if (tags.includes(',')) {
                tags = tags.split(',')
              }else {
                tags = [tags]
              }
              for (var i = 0; i < tags.length; i++) {
                for (var x = 0; x < self.tags.length; x++) {
                  if (self.tags[x].name === tags[i]) {
                    Vue.set(self.tags[x],'active',true)
                    tags.splice(i, 1)
                  }
                }
              }
            }
            if (tags && tags.length){
              self.tagsNotFound = tags
              console.warn('TAGS NOT FOUND', self.tagsNotFound)
            }

            var owners = url.searchParams.get("owners");
            if (owners) {
              if (owners.includes(',')) {
                owners = owners.split(',')
              }else {
                owners = [owners]
              }
              for (var i = 0; i < owners.length; i++) {
                for (var x = 0; x < self.authors.length; x++) {
                  if (self.authors[x].name === owners[i]) {
                    owners.splice(i, 1)
                    Vue.set(self.authors[x],'active',true)
                  }
                }
              }
            }
            if (owners && owners.length){   
              self.ownersNotFound = owners
              console.warn('OWNERS NOT FOUND', self.ownersNotFound)
            }

            if (!owners && !tags){
              self.ownersNotFound = []
              self.tagsNotFound = []
            }

          },
          getAnalytics(){
            var self = this;
            axios.get('https://gasuperproxy-1470690417190.appspot.com/query?id=ahxzfmdhc3VwZXJwcm94eS0xNDcwNjkwNDE3MTkwchULEghBcGlRdWVyeRiAgIDMgsmRCgw').then(res=>{
              if (res.data.rows) {
                var payload = {};
                let analytics = res.data.rows;
                let pop = []
                for (var i = 0; i < analytics.length; i++) {
                  if (analytics[i][0] ==='tag') {
                    let name = analytics[i][1];
                    if(!name.includes(' ')){
                      pop.push({'name':name,'active':false,'count':analytics[i][2],'type':'tags'})
                    }else{
                      pop.push({'name':name,'active':false,'count':analytics[i][2],'type':'owners'})
                    }
                  }
                }
                self.popularTags = pop;
              }

            }).catch(err=>{
              throw err;
            });
          },
          toggleTag(tag,type){
            let self = this;
            switch (type) {
              case 'author':
                self.toggleThisAuthor(tag)
                break;
              case 'tag':
                self.toggleThisTag(tag)
                break;
              default:
                return false
            }
          },
          toggleThisTag(tag){
            let self = this;
            for (var i = 0; i < self.tags.length; i++) {
                if (self.tags[i].name === tag.name) {
                  Vue.set(self.tags[i],'active',!self.tags[i]['active'])
                }
              }
          },
          toggleThisAuthor(author){
            let self = this;
            for (var i = 0; i < self.authors.length; i++) {
              if (self.authors[i].name === author.name) {
                Vue.set(self.authors[i],'active',!self.authors[i]['active'])
              }
            }
          },
      },
      created: function () {
          let self = this;
          self.getUserInfo();
          $(".button-collapse").sideNav();
          $('.collapsible').collapsible();
          self.loadFilters();
          if ({{Context}}) {
            self.context = {{Context}};
          }

      },
      mounted: function(){
        var self = this;

        window.onpopstate = function(event) {
          self.initialAPILoad();
        };

        this.getAnalytics();

        tippy('#myAPITipCont',{
              target: '.tipped',
              placement: 'top',
              theme:'light',
              sticky:true,
              interactive:true,
              onShow(instance) {
                let status = instance.reference.dataset.tippyStatus;
                let msg = [200, 299, '200', '299'].includes(status) ? 'This API belongs to you. Manage it on your <a href="/dashboard">dashboard</a>.' : '<b class="red-text">API metadata cannot be synchronized with its source URL due to an error.</b> <br>Fix the issue and refresh it from your <a href="/dashboard">dashboard</a>.'
                instance.setContent("<div class='p-1 blue-text left-align'>"+msg+"</div>")
              },
            });

        tippy( '#tippyParentCopy', {
            target: '.copyBtn',
            content:'Copied',
            animateFill: false,
            animation: 'fade',
            theme:'light',
            trigger:'click'});

        tippy( '#top-2', {
          target: '.urlStatus',
          content: `<div class="white" style="padding:0px;">
                      <table>
                        <thead>
                          <tr>
                            <td colspan="2" class='grey-text center'>
                              <b>API Metadata Source URL Status</b>
                            </td>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td class='green-text center'>
                              <b>OK</b>
                            </td>
                            <td class="black-text">
                              <small>Source URL is working and returns valid metadata.</small>
                            </td>
                          </tr>
                          <tr>
                            <td class='orange-text center'>
                              <b>NOT FOUND</b>
                            </td>
                            <td class="black-text">
                              <small>Source URL returns not found.</small>
                            </td>
                          </tr>
                          <tr>
                            <td class='red-text center'>
                              <b>INVALID</b>
                            </td>
                            <td class="black-text">
                              <small>Source URL works but contains invalid metadata.</small>
                            </td>
                          </tr>
                          <tr>
                            <td class='purple-text center'>
                              <b>BROKEN</b>
                            </td>
                            <td class="black-text">
                              <small>Source URL is broken.</small>
                            </td>
                          </tr>
                          <tr class="cyan lighten-5">
                            <td colspan='2' class='blue-grey-text'>
                              <p>
                                <b>Note: </b> API metadata cannot be synchronized with its source URL if the status is not <b class='green-text'>OK</b>. 
                              </p>
                              <p>
                                <b>Need help?</b> From your <a href="/dashboard">User Dashboard</a> &gt; <b class='indigo-text'>Validate Only</b> to see issues then <b class='green-text'>Refresh</b> once all issues have been resolved.
                              </p>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>`,
          placement: 'left',
          theme:'light',
          trigger:'click',
          sticky:true,
          interactive:true,
        });

        tippy( '#top', {
          target: '.apiStatus',
          content: `<div class="white" style="padding:0px;">
                      <table>
                        <thead>
                          <tr>
                            <td colspan="2" class='grey-text center'>
                              <b>Overall API Endpoint Uptime Status</b>
                            </td>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td class='green-text center'>
                              <b>PASS</b>
                            </td>
                            <td class="black-text">
                              <small>Your OpenAPI V3 API endpoints provide examples and all return code 200.</small>
                            </td>
                          </tr>
                          <tr>
                            <td class='red-text center'>
                              <b>FAIL</b>
                            </td>
                            <td class="black-text">
                              <small>Your OpenAPI V3 API endpoints provide examples but return code other than 200.</small>
                            </td>
                          </tr>
                          <tr> 
                            <td class='orange-text center'>
                              <b>UNKNOWN</b>
                            </td>
                            <td class="black-text">
                              <small>None of your OpenAPI V3 API endpoints provide examples and cannot be tested. <a href='/faq#api-monitor' target="_blank">Learn more about how to to enable API status check </a>.</small>
                            </td>
                          </tr>
                          <tr>
                            <td class='blue-text center'>
                              <b>INCOMPATIBLE</b>
                            </td>
                            <td class="black-text">
                              <small>Your API's specification does not match OpenAPI V3 specification and will not be tested. Use our guide to learn how to upgrade your metadata to OpenAPI V3 <a href="/guide" target="_blank">here</a>.</small>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>`,
          placement: 'left',
          theme:'light',
          trigger:'click',
          sticky:true,
          interactive:true,
        });

      },
      updated: function(){
        // Highlight matches in results
        this.highlightQuery();
      },
      watch:{
        tagsearch:function(q){
          var self = this;

          if (q.length) {
            let result = _.filter(self.tags, function(o) {
                if (o['name'].toLowerCase().includes(q.toLowerCase())) {
                  return o;
                }
            });
            self.tagSearchResults = result;
          }else {
            this.tagSearchResults = [];
          }

        },
        ownersearch:function(q){
          var self = this;

          if (q.length) {
            let result = _.filter(self.authors, function(o) {
                if (o['name'].toLowerCase().includes(q.toLowerCase())) {
                  return o;
                }
            });
            self.ownerSearchResults = result;
          }else {
            this.ownerSearchResults = [];
          }

        },
        listAll:function(b){
          var self = this;
          if (b) {
            self.listCap = 1000;
          }else {
            self.listCap = 20;
          }
        },
      }
  });
</script>
{% endblock %}
